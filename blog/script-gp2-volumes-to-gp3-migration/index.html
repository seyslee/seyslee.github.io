<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>gp2 to gp3 마이그레이션 스크립트 &#183; seyslee</title><meta name=title content="gp2 to gp3 마이그레이션 스크립트 &#183; seyslee"><meta name=description content="seyslee"><link rel=canonical href=https://seyslee.github.io/blog/script-gp2-volumes-to-gp3-migration/><link type=text/css rel=stylesheet href=/css/main.bundle.min.4237a54696344545847852e66642dc3be0dbc6296c3890031b5dfb8c9aaf683fc56c227436ecf341b430c4c690554013087987403de93d86e94529f0f48a3ab8.css integrity="sha512-QjelRpY0RUWEeFLmZkLcO+DbxilsOJADG137jJqvaD/FbCJ0NuzzQbQwxMaQVUATCHmHQD3pPYbpRSnw9Io6uA=="><script type=text/javascript src=/js/appearance.min.12e98742cd283574d030a7fe55f29597df4ee214f7ff7075b4d19a64d046a602753c715295550be7899b661619cec89c679049d36c624681671a8013c1249896.js integrity="sha512-EumHQs0oNXTQMKf+VfKVl99O4hT3/3B1tNGaZNBGpgJ1PHFSlVUL54mbZhYZzsicZ5BJ02xiRoFnGoATwSSYlg=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9ae0a991bb442898e9bc60cf318b4de3ff878325ff3821625a5564b32b2f66aec0e7f7d0e00ca3ac7df59d9f01c18c88b6bdd213184f86ac9ce06d7bdffbadf8.js integrity="sha512-muCpkbtEKJjpvGDPMYtN4/+HgyX/OCFiWlVksysvZq7A5/fQ4AyjrH31nZ8BwYyItr3SExhPhqyc4G173/ut+A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="gp2 to gp3 마이그레이션 스크립트"><meta property="og:description" content="gp2 볼륨 전체를 gp3로 마이그레이션하는 AWS CLI 스크립트"><meta property="og:type" content="article"><meta property="og:url" content="https://seyslee.github.io/blog/script-gp2-volumes-to-gp3-migration/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-06-03T22:44:30+09:00"><meta property="article:modified_time" content="2022-06-03T23:11:35+09:00"><meta property="og:site_name" content="seyslee"><meta name=twitter:card content="summary"><meta name=twitter:title content="gp2 to gp3 마이그레이션 스크립트"><meta name=twitter:description content="gp2 볼륨 전체를 gp3로 마이그레이션하는 AWS CLI 스크립트"><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blogs","name":"gp2 to gp3 마이그레이션 스크립트","headline":"gp2 to gp3 마이그레이션 스크립트","description":"gp2 볼륨 전체를 gp3로 마이그레이션하는 AWS CLI 스크립트","abstract":"개요 # 지정한 리전의 gp2 볼륨을 gp3로 모두 마이그레이션 하는 방법을 소개합니다.","inLanguage":"en","url":"https:\/\/seyslee.github.io\/blog\/script-gp2-volumes-to-gp3-migration\/","author":{"@type":"Person","name":"Younsung Lee"},"copyrightYear":"2022","dateCreated":"2022-06-03T22:44:30\u002b09:00","datePublished":"2022-06-03T22:44:30\u002b09:00","dateModified":"2022-06-03T23:11:35\u002b09:00","keywords":["aws"],"mainEntityOfPage":"true","wordCount":"394"}]</script><meta name=author content="Younsung Lee"><link href=mailto:ivecloudblack@gmail.com rel=me><link href=https://github.com/seyslee rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>seyslee</a></div><nav><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/blog/ title=Blogs>post</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>tag</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">gp2 to gp3 마이그레이션 스크립트</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-06-03 22:44:30 +0900 +0900">Jun 3, 2022</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2022-06-03 23:11:35 +0900 +0900">Updated: Jun 3, 2022</time></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#개요>개요</a></li><li><a href=#전제조건>전제조건</a></li><li><a href=#사용법>사용법</a></li><li><a href=#주의사항>주의사항</a></li><li><a href=#데모>데모</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><h1 id=개요 class="relative group">개요 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b0%9c%ec%9a%94 aria-label=Anchor>#</a></span></h1><p>지정한 리전의 gp2 볼륨을 gp3로 모두 마이그레이션 하는 방법을 소개합니다.</p><p>AWS Management Console에서도 수작업으로 가능하지만 이 글에서는 AWS CLI를 활용한 쉘 스크립트로 변경 작업을 진행합니다.</p><p>gp3로 변경해야할 EBS 볼륨이 200개인데 AWS Management Console로 하나씩 작업하는 일은 지옥입니다.</p><br><h1 id=전제조건 class="relative group">전제조건 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%a0%84%ec%a0%9c%ec%a1%b0%ea%b1%b4 aria-label=Anchor>#</a></span></h1><p><strong>jq 설치</strong></p><p>스크립트 안에서 json 응답을 파싱해서 Volume ID와 Volume 상태를 추출하도록 동작하기 때문에, 스크립트를 실행하는 클라이언트에 <code>jq</code> 설치가 필요합니다.</p><p>macOS의 경우 패키지 관리자인 brew를 통해 쉽게 설치가 가능합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ brew install jq
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ jq --version
</span></span><span class=line><span class=cl>jq-1.6
</span></span></code></pre></div><br><p><strong>AWS CLI</strong></p><p>AWS CLI 설치와 인증이 미리 구성된 상태여야 합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ aws --version
</span></span><span class=line><span class=cl>aws-cli/2.7.5 Python/3.9.13 Darwin/21.5.0 source/arm64 prompt/off
</span></span></code></pre></div><br><h1 id=사용법 class="relative group">사용법 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%82%ac%ec%9a%a9%eb%b2%95 aria-label=Anchor>#</a></span></h1><p><strong>jq 설치 확인</strong></p><p>스크립트 실행 전에 jq 명령어가 설치되어 있는지 확인</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ which jq
</span></span><span class=line><span class=cl>/opt/homebrew/bin/jq
</span></span></code></pre></div><br><p><strong>스크립트 작성</strong></p><p><a href=./gp3-migration.sh>gp3-migration.sh</a></p><p>그대로 스크립트를 실행하면 안되고, <code>region</code> 변수는 자신의 환경에 맞게 변경합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>region</span><span class=o>=</span><span class=s1>&#39;ap-northeast-2&#39;</span>
</span></span></code></pre></div><br><p><strong>스크립트 실행</strong></p><pre tabindex=0><code>$ sh gp3-migration.sh
</code></pre><br><h1 id=주의사항 class="relative group">주의사항 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%a3%bc%ec%9d%98%ec%82%ac%ed%95%ad aria-label=Anchor>#</a></span></h1><p>스크립트를 실행하게 되면 지정한 AWS 리전에 위치한 모든 gp2 볼륨이 gp3로 변경 시작됩니다.</p><p>볼륨 타입 변경 과정은 기본적으로 무중단으로 진행되기 때문에 실제 프로덕션 환경에서 실행하더라도 서비스에는 영향을 주지 않고 안전하게 완료됩니다.</p><ul><li><p>상황에 따라 EBS 볼륨 타입 변경이 최대 24시간 소요될 수 있습니다.</p></li><li><p>한 번 스펙을 변경한 EBS 볼륨은 6시간이 지난 후에 다시 변경 가능합니다.</p><p><figure><img class="my-0 rounded-md" src=./1.png alt></figure></p></li><li><p>타입 변경이 진행 중인 EBS 볼륨의 상태는 콘솔에서 확인할 때 <code>In-use - optimizing (n%)</code>으로 표시됩니다.</p></li><li><p>Amazon EKS<sup>Elastic Kubernetes Service</sup> 노드에서 gp3, io2 타입의 EBS 볼륨을 사용하려면 EBS CSI Driver 구성이 필요합니다.<br><a href=https://aws.amazon.com/ko/blogs/containers/migrating-amazon-eks-clusters-from-gp2-to-gp3-ebs-volumes/>[1] gp2 to gp3 migration</a>, <a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/ebs-csi.html>[2] EBS CSI Driver</a></p></li></ul><br><h1 id=데모 class="relative group">데모 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%8d%b0%eb%aa%a8 aria-label=Anchor>#</a></span></h1><p><strong>터미널</strong></p><p><code>gp3-migration.sh</code> 스크립트를 실행하면 터미널에 결과값이 나타납니다.<br>이 예제에서는 7개의 gp2 타입이 서울 리전에 존재하고, 이를 일괄 변경하는 시나리오입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sh gp3-migration.sh
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> Start finding all gp2 volumes in ap-northeast-2
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> List up all gp2 volume in ap-northeast-2
</span></span><span class=line><span class=cl>vol-11111111111111111 vol-22222222222222222 vol-33333333333333333 vol-44444444444444444 vol-55555555555555555 vol-66666666666666666 vol-77777777777777777
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> <span class=o>=============================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> Migrating all gp2 volumes to gp3
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> OK: volume vol-11111111111111111 changed to state <span class=s1>&#39;modifying&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> OK: volume vol-22222222222222222 changed to state <span class=s1>&#39;modifying&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> OK: volume vol-33333333333333333 changed to state <span class=s1>&#39;modifying&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> OK: volume vol-44444444444444444 changed to state <span class=s1>&#39;modifying&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> OK: volume vol-55555555555555555 changed to state <span class=s1>&#39;modifying&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> OK: volume vol-66666666666666666 changed to state <span class=s1>&#39;modifying&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>i<span class=o>]</span> OK: volume vol-77777777777777777 changed to state <span class=s1>&#39;modifying&#39;</span>
</span></span></code></pre></div><br><p><strong>AWS Management Console</strong></p><p><code>gp3-migration.sh</code> 스크립트를 실행한 후 AWS Management Console → EC2 → Volume 페이지를 확인합니다.</p><br><p><figure><img class="my-0 rounded-md" src=./2.png alt></figure></p><p>타입 변경이 진행중인 EBS 볼륨의 상태는 <code>in-use - optimizing</code>으로 표시됩니다.<br>gp2 → gp3 타입 변경은 EBS의 사용중인 용량, 인프라 환경에 따라 최대 24시간 소요될 수 있습니다.</p><br><p><figure><img class="my-0 rounded-md" src=./3.png alt></figure></p><p>잠시 기다리면 볼륨 상태가 <code>in-use</code>로 바뀌며 볼륨 타입이 변경 완료됩니다.</p><p>작업 완료!</p></div></section><footer class="pt-8 max-w-prose print:hidden"><script src=https://utteranc.es/client.js repo=seyslee/seyslee.github.io issue-term=pathname label=blog-comment theme=github-dark crossorigin=anonymous async></script></footer></article></main><footer class="py-10 print:hidden"><div class="flex justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Younsung Lee</p></div></div></footer></div></body></html>