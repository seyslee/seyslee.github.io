<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>AWS Transfer Family 테라폼 구축하기 &#183; seyslee</title><meta name=title content="AWS Transfer Family 테라폼 구축하기 &#183; seyslee"><meta name=description content="seyslee"><link rel=canonical href=https://seyslee.github.io/blog/deploy-sftp-transfer-family-via-terraform/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fff8ff4cdbe2bf80930c53b6e47a6d9826b914a8623246481ff09ff52ea48fcfb403d9ba1dc7bbc800a7ecb15298c468838a661dd8ebb3e9f46fdca239b38a30.css integrity="sha512-//j/TNviv4CTDFO25HptmCa5FKhiMkZIH/Cf9S6kj8+0A9m6Hce7yACn7LFSmMRog4pmHdjrs+n0b9yiObOKMA=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9947db70e5b36e741e53f8531bd734741b3fc7a688f7b5d749fc5433c48efc252f47bdf44e471570a550fc051b87712799014040e6349b38d64448b94e84e45a.js integrity="sha512-mUfbcOWzbnQeU/hTG9c0dBs/x6aI97XXSfxUM8SO/CUvR730TkcVcKVQ/AUbh3EnmQFAQOY0mzjWREi5ToTkWg==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="AWS Transfer Family 테라폼 구축하기"><meta property="og:description" content="테라폼을 사용해서 AWS Transfer Family의 SFTP 서버를 구축하는 방법을 소개합니다."><meta property="og:type" content="article"><meta property="og:url" content="https://seyslee.github.io/blog/deploy-sftp-transfer-family-via-terraform/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-06-17T03:17:10+09:00"><meta property="article:modified_time" content="2022-06-17T11:23:15+09:00"><meta property="og:site_name" content="seyslee"><meta name=twitter:card content="summary"><meta name=twitter:title content="AWS Transfer Family 테라폼 구축하기"><meta name=twitter:description content="테라폼을 사용해서 AWS Transfer Family의 SFTP 서버를 구축하는 방법을 소개합니다."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blogs","name":"AWS Transfer Family 테라폼 구축하기","headline":"AWS Transfer Family 테라폼 구축하기","description":"테라폼을 사용해서 AWS Transfer Family의 SFTP 서버를 구축하는 방법을 소개합니다.","abstract":"개요 # 테라폼을 사용해 AWS Transfer Family와 S3를 배포해서 서비스해보는 과정입니다.","inLanguage":"en","url":"https:\/\/seyslee.github.io\/blog\/deploy-sftp-transfer-family-via-terraform\/","author":{"@type":"Person","name":"Younsung Lee"},"copyrightYear":"2022","dateCreated":"2022-06-17T03:17:10\u002b09:00","datePublished":"2022-06-17T03:17:10\u002b09:00","dateModified":"2022-06-17T11:23:15\u002b09:00","keywords":["aws","terraform"],"mainEntityOfPage":"true","wordCount":"1087"}]</script><meta name=author content="Younsung Lee"><link href=mailto:ivecloudblack@gmail.com rel=me><link href=https://github.com/seyslee rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>seyslee</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/blog/ title=Blogs>post</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>tag</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">AWS Transfer Family 테라폼 구축하기</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-06-17 03:17:10 +0900 +0900">Jun 17, 2022</time></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><a href=#개요>개요</a></li><li><a href=#환경>환경</a></li><li><a href=#전제조건>전제조건</a></li><li><a href=#실습하기>실습하기</a><ul><li><a href=#테라폼-코드>테라폼 코드</a></li><li><a href=#aws-cli-권한-확인>AWS CLI 권한 확인</a></li><li><a href=#테라폼-배포>테라폼 배포</a></li><li><a href=#ssh-키-생성>SSH 키 생성</a></li><li><a href=#sftp-유저의-ssh-키-등록>SFTP 유저의 SSH 키 등록</a></li><li><a href=#sftp-접속>SFTP 접속</a></li><li><a href=#파일-업로드-테스트>파일 업로드 테스트</a></li><li><a href=#실습환경-정리>실습환경 정리</a></li></ul></li><li><a href=#참고자료>참고자료</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><h2 id=개요 class="relative group">개요 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b0%9c%ec%9a%94 aria-label=Anchor>#</a></span></h2><p>테라폼을 사용해 AWS Transfer Family와 S3를 배포해서 서비스해보는 과정입니다.</p><p>AWS Transfer Family는 SFTP 서버의 관리형 서비스입니다.</p><p>AWS Transfer Family를 사용하면 SFTP 서버 구축에 필요한 네트워크 구성, EC2 생성, SFTP 서버 패키지 설치 & 설정 등의 인프라 작업이 필요 없어집니다. AWS에서 SFTP 서버를 서버리스로 운영해주기 떄문입니다. SFTP 사용자 관리, 로깅, 엔드포인트 관리도 편합니다.<br>단점은 엔지니어가 편해지는 만큼 가격이 비쌉니다.</p><p>테라폼으로 구성할 아키텍처는 다음과 같습니다.</p><p><figure><img class="my-0 rounded-md" src=./1.png alt="Architecture of AWS Transfer Family"></figure></p><p>Transfer Family 사용자가 SFTP 서버에 로그인할 때는 ID, Password 방식이 아닌 SSH 키페어 인증으로 로그인하게 됩니다.</p><p> </p><h2 id=환경 class="relative group">환경 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%99%98%ea%b2%bd aria-label=Anchor>#</a></span></h2><ul><li><strong>Terraform v1.2.3</strong></li><li><strong>AWS CLI 2.7.7</strong></li><li><strong>Shell</strong> : zsh + oh-my-zsh</li><li><strong>OS</strong> : macOS Monterey 12.4 (M1 Pro)</li></ul><p> </p><h2 id=전제조건 class="relative group">전제조건 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%a0%84%ec%a0%9c%ec%a1%b0%ea%b1%b4 aria-label=Anchor>#</a></span></h2><ul><li><p>테라폼이 설치되어 있어야 합니다.</p></li><li><p>테라폼으로 AWS 리소스를 배포하기 위해서 AWS CLI에 충분한 권한이 부여되어 있어야 합니다.</p></li><li><p>AWS CLI가 설치되어 있어야 합니다.</p><p>테라폼에서 SFTP 서버의 Hostname 설정을 지원하지 않아서, 불가피하게 Hostname 설정만 AWS CLI를 사용합니다. <code>sftp-server-hostname.tf</code> 참조.</p></li></ul><p> </p><h2 id=실습하기 class="relative group">실습하기 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%8b%a4%ec%8a%b5%ed%95%98%ea%b8%b0 aria-label=Anchor>#</a></span></h2><h3 id=테라폼-코드 class="relative group">테라폼 코드 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%85%8c%eb%9d%bc%ed%8f%bc-%ec%bd%94%eb%93%9c aria-label=Anchor>#</a></span></h3><h4 id=다운로드 class="relative group">다운로드 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%8b%a4%ec%9a%b4%eb%a1%9c%eb%93%9c aria-label=Anchor>#</a></span></h4><p>실습에 필요한 테라폼 코드 전체를 다운로드 받습니다.<br><a href="https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/seyslee/piki/tree/main/docs/terraform/terraform-set/aws-transfer-family/terraform-codes">다운로드</a></p><h4 id=코드-구조 class="relative group">코드 구조 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%bd%94%eb%93%9c-%ea%b5%ac%ec%a1%b0 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>└── terraform-codes
</span></span><span class=line><span class=cl>    ├── outputs.tf
</span></span><span class=line><span class=cl>    ├── provider.tf
</span></span><span class=line><span class=cl>    ├── route53.tf               <span class=c1># Route 53</span>
</span></span><span class=line><span class=cl>    ├── s3.tf                    <span class=c1># S3 Bucket</span>
</span></span><span class=line><span class=cl>    ├── sftp-server-hostname.tf  <span class=c1># SFTP Server</span>
</span></span><span class=line><span class=cl>    ├── sftp-server-iam.tf       <span class=c1># SFTP Server</span>
</span></span><span class=line><span class=cl>    ├── sftp-server.tf           <span class=c1># SFTP Server</span>
</span></span><span class=line><span class=cl>    ├── transfer-user-iam.tf     <span class=c1># SFTP User</span>
</span></span><span class=line><span class=cl>    ├── transfer-user.tf         <span class=c1># SFTP User</span>
</span></span><span class=line><span class=cl>    └── variables.tf             <span class=c1># AWS Region</span>
</span></span></code></pre></div><h4 id=코드-수정 class="relative group">코드 수정 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%bd%94%eb%93%9c-%ec%88%98%ec%a0%95 aria-label=Anchor>#</a></span></h4><p>실습을 진행하기 전에 각자 환경에 맞게 코드를 수정해주세요.</p><p><strong>S3 버킷 이름</strong><br>S3 버킷은 글로벌 환경에서 유니크한 이름을 가져야 합니다.<br><code>variables.tf</code>에서 S3 버킷 이름을 다른 사람과 겹치지 않도록 변경해주세요.<br>변경하지 않으면 버킷 이름이 중복되는 오류가 발생해 S3 버킷이 생성되지 않습니다.</p><p><strong>리전</strong><br>디폴트 값으로 SFTP 서버가 서울 리전<sup>ap-northeast-2</sup>에 배포되도록 설정되어 있습니다.<br>자세한 내용은 <code>variables.tf</code>를 참조하세요.</p><p> </p><h3 id=aws-cli-권한-확인 class="relative group">AWS CLI 권한 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#aws-cli-%ea%b6%8c%ed%95%9c-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h3><p><code>terraform</code> 명령어를 실행하기 전에 AWS CLI에 Administrator 권한이 부여되어 있어야 합니다.</p><p>AWS CLI에서 현재 자신이 어떤 IAM User를 사용하고 있는지 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ aws sts get-caller-identity
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;UserId&#34;</span>: <span class=s2>&#34;AIDAXQOVWG6FYM3OPCLJX&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Account&#34;</span>: <span class=s2>&#34;111111111111&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Arn&#34;</span>: <span class=s2>&#34;arn:aws:iam::111111111111:user/tf-admin&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>제 경우는 Administrator 권한이 부여되어 있는 테라폼 전용 IAM User를 사용하고 있습니다.</p><p> </p><h3 id=테라폼-배포 class="relative group">테라폼 배포 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%85%8c%eb%9d%bc%ed%8f%bc-%eb%b0%b0%ed%8f%ac aria-label=Anchor>#</a></span></h3><p>AWS CLI의 권한이 부여된 상태에서 아래 테라폼 명령어를 실행합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ terraform init
</span></span></code></pre></div><p> </p><p><code>terraform init</code> 명령어를 수행하면 생성되는 <code>.terraform.lock.hcl</code> 파일에서 설정된 Terraform Provider 버전 정보를 확인할 수 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat .terraform.lock.hcl
</span></span><span class=line><span class=cl><span class=c1># This file is maintained automatically by &#34;terraform init&#34;.</span>
</span></span><span class=line><span class=cl><span class=c1># Manual edits may be lost in future updates.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>provider <span class=s2>&#34;registry.terraform.io/hashicorp/aws&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>version</span>     <span class=o>=</span> <span class=s2>&#34;4.19.0&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>constraints</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 4.0&#34;</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>provider <span class=s2>&#34;registry.terraform.io/hashicorp/null&#34;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nv>version</span>     <span class=o>=</span> <span class=s2>&#34;3.1.1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>constraints</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 3.1&#34;</span>
</span></span><span class=line><span class=cl>  ...
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>이 시나리오에서 terraform provider는 2개를 사용합니다.</p><ul><li><strong>hashicorp/aws</strong> v4.19.0</li><li><strong>hashicorp/null</strong> v3.1.1</li></ul><p><code>aws</code> 프로바이더는 AWS 리소스 배포에 사용합니다.<br><code>null</code> 프로바이더는 SFTP Server의 Custom Hostname 설정에 사용합니다.<br>null provider는 사용자의 로컬 터미널에서 AWS CLI를 실행해 SFTP Server에 Custom Hostname를 추가합니다.<br>자세한 내용은 <code>sftp-server-hostname.tf</code> 파일에서 확인 가능합니다.</p><p> </p><p><code>terraform plan</code> 명령어로 배포될 리소스들의 정보를 확인합니다.</p><pre tabindex=0><code>$ terraform plan
</code></pre><p> </p><p>이후 리소스 배포를 실시합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ terraform apply
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Apply complete! Resources: <span class=m>13</span> added, <span class=m>0</span> changed, <span class=m>0</span> destroyed.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Outputs:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bucket-name <span class=o>=</span> <span class=s2>&#34;rocket-x82q-sftp-bucket&#34;</span>
</span></span><span class=line><span class=cl>sftp-server-endpoint <span class=o>=</span> <span class=s2>&#34;s-993ae220554f4c50a.server.transfer.ap-northeast-2.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>sftp-server-id <span class=o>=</span> <span class=s2>&#34;s-993ae220554f4c50a&#34;</span>
</span></span><span class=line><span class=cl>sftp-username <span class=o>=</span> <span class=s2>&#34;alice&#34;</span>
</span></span></code></pre></div><p>13개의 AWS 리소스를 문제없이 배포했습니다.</p><p>Route 53에 개인 소유 도메인이 없는 분들은 아쉽게도 <code>sftp-server-endpoint</code> 값으로 SFTP 서버에 로그인해야 합니다.</p><p> </p><h3 id=ssh-키-생성 class="relative group">SSH 키 생성 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#ssh-%ed%82%a4-%ec%83%9d%ec%84%b1 aria-label=Anchor>#</a></span></h3><p>테라폼으로 리소스 배포가 완료된 이후
SFTP Transfer 유저가 사용할 SSH 키페어를 생성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ssh-keygen -f sftp-alice
</span></span><span class=line><span class=cl>Generating public/private rsa key pair.
</span></span><span class=line><span class=cl>Enter passphrase <span class=o>(</span>empty <span class=k>for</span> no passphrase<span class=o>)</span>:
</span></span><span class=line><span class=cl>Enter same passphrase again:
</span></span><span class=line><span class=cl>Your identification has been saved in sftp-alice
</span></span><span class=line><span class=cl>Your public key has been saved in sftp-alice.pub
</span></span><span class=line><span class=cl>The key fingerprint is:
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>passphrase는 빈칸으로 입력해서 키를 생성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ls sftp-alice*
</span></span><span class=line><span class=cl>sftp-alice     sftp-alice.pub
</span></span></code></pre></div><p>비밀키 <code>sftp-alice</code>와 공개키 <code>sftp-alice.pub</code>이 생성된 걸 확인할 수 있습니다.</p><p> </p><h3 id=sftp-유저의-ssh-키-등록 class="relative group">SFTP 유저의 SSH 키 등록 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sftp-%ec%9c%a0%ec%a0%80%ec%9d%98-ssh-%ed%82%a4-%eb%93%b1%eb%a1%9d aria-label=Anchor>#</a></span></h3><p>SFTP 유저가 서버에 접속하려면 SSH 키를 미리 SFTP 서버에 등록해야 합니다.</p><p><figure><img class="my-0 rounded-md" src=./2.png alt="SSH Key pair architecture"></figure></p><p>공개키의 내용을 확인하고 복사합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat sftp-alice.pub
</span></span><span class=line><span class=cl>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCpmWwof7SgjqepEgFYkHEZEfR84Za7WBKM2b5wvWvPN4u/RcksOXXmn9LMEvLH6ZMx27tBq1Lh/fJet/QKLtntYBjS9WIwsgI2szJRYoiTxpbJOz6vuh13XIO8YUeirb4KLkpMbnj7vkAuU6BGJ5WHgTcVgzM1sPgqNLVxOHy4p2EmKkz1z3EDMolhUm9v0COMw4+8YW78HBizuBdLmIP23o9pNfnKBTtnNHtaIFhJi9f1OK4IvMM+n+sBikrA8mtmMPoTS+agsSFi+LIcqdj00cbm8KAcMtYImQSIjhcUGG+0aPjePOI0Qkj0D0+00GdIxGhJsgbRt+chDHfs1jWQ6ha0SK6Pl3ceQHLtb4mskhQQu78ObTVbt0VNsoRnzhdHVxgisVZGqGsJhY1ahbr0BZn//XrN7zfzRCU203qlbJc76GMWVM+SLNi3zOJYF/rbDJgpIoIwEvqppSrWQUfcPQo0VRxJY1suVd0ms0xeoWjd0sSbIhowBIcASJxQ0X0<span class=o>=</span> xxxxx@xxxxxui-MacBookPro.local
</span></span></code></pre></div><p>AWS Management Console로 돌아가서 아까 생성한 SSH 공개키(<code>sftp-alice.pub</code>)를 Transfer User에 등록합니다.</p><p><figure><img class="my-0 rounded-md" src=./3.png alt="User에 SSH public key를 등록 화면 1"></figure></p><p>공개키 <code>sftp-alice.pub</code>의 내용을 그대로 복사해서 넣어주세요.<br>그 후 [Add key] 버튼을 눌러 SSH 공개키를 등록합니다.</p><p><figure><img class="my-0 rounded-md" src=./4.png alt="User에 SSH public key를 등록 화면 2"></figure></p><p>SFTP 서버 세팅이 끝났습니다.</p><p> </p><h3 id=sftp-접속 class="relative group">SFTP 접속 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#sftp-%ec%a0%91%ec%86%8d aria-label=Anchor>#</a></span></h3><p>이제 SFTP 사용자가 SFTP Client 프로그램을 사용해 서버에 접근하면 됩니다.</p><p>SFTP 접속 명령어는 다음과 같습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sftp -i private_key sftp_username@sftp_server_endpoint
</span></span></code></pre></div><p>테라폼 코드를 실행하면 Route 53의 Zone과 Record가 생성됩니다.<br>그러나 제 경우는 개인 소유의 도메인이 없어서 SFTP에 접속할 때 도메인 대신 Server Endpoint로 접속하게 되었습니다.</p><p>Server Endpoint 주소는 <code>terraform apply</code>로 생성이 완료된 후 마지막 라인 <code>Outputs</code>에 자동 출력됩니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sftp -i sftp-alice alice@s-4798bd8d19d646609.server.transfer.ap-northeast-2.amazonaws.com
</span></span></code></pre></div><p>서버에 정상적으로 로그인될 경우 다음과 같은 메세지가 출력되면서 프롬프트가 <code>sftp></code>로 변경됩니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Connected to s-4798bd8d19d646609.server.transfer.ap-northeast-2.amazonaws.com.
</span></span><span class=line><span class=cl>sftp&gt;
</span></span></code></pre></div><p>사용자가 최초 로그인했을 때 위치하는 경로는 각 유저의 홈 디렉토리인 걸 확인할 수 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sftp&gt; <span class=nb>pwd</span>
</span></span><span class=line><span class=cl>Remote working directory: /rocket-x82q-sftp-bucket/alice
</span></span></code></pre></div><p><code>help</code> 명령어를 실행해서 전체 SFTP 명령어 리스트를 확인할 수 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sftp&gt; <span class=nb>help</span>
</span></span><span class=line><span class=cl>Available commands:
</span></span><span class=line><span class=cl>bye                                Quit sftp
</span></span><span class=line><span class=cl><span class=nb>cd</span> path                            Change remote directory to <span class=s1>&#39;path&#39;</span>
</span></span><span class=line><span class=cl>chgrp <span class=o>[</span>-h<span class=o>]</span> grp path                Change group of file <span class=s1>&#39;path&#39;</span> to <span class=s1>&#39;grp&#39;</span>
</span></span><span class=line><span class=cl>chmod <span class=o>[</span>-h<span class=o>]</span> mode path               Change permissions of file <span class=s1>&#39;path&#39;</span> to <span class=s1>&#39;mode&#39;</span>
</span></span><span class=line><span class=cl>chown <span class=o>[</span>-h<span class=o>]</span> own path                Change owner of file <span class=s1>&#39;path&#39;</span> to <span class=s1>&#39;own&#39;</span>
</span></span><span class=line><span class=cl>df <span class=o>[</span>-hi<span class=o>]</span> <span class=o>[</span>path<span class=o>]</span>                    Display statistics <span class=k>for</span> current directory or
</span></span><span class=line><span class=cl>                                   filesystem containing <span class=s1>&#39;path&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span>                               Quit sftp
</span></span><span class=line><span class=cl>get <span class=o>[</span>-afpR<span class=o>]</span> remote <span class=o>[</span>local<span class=o>]</span>         Download file
</span></span><span class=line><span class=cl><span class=nb>help</span>                               Display this <span class=nb>help</span> text
</span></span><span class=line><span class=cl>lcd path                           Change <span class=nb>local</span> directory to <span class=s1>&#39;path&#39;</span>
</span></span><span class=line><span class=cl>lls <span class=o>[</span>ls-options <span class=o>[</span>path<span class=o>]]</span>            Display <span class=nb>local</span> directory listing
</span></span><span class=line><span class=cl>lmkdir path                        Create <span class=nb>local</span> directory
</span></span><span class=line><span class=cl>ln <span class=o>[</span>-s<span class=o>]</span> oldpath newpath            Link remote file <span class=o>(</span>-s <span class=k>for</span> symlink<span class=o>)</span>
</span></span><span class=line><span class=cl>lpwd                               Print <span class=nb>local</span> working directory
</span></span><span class=line><span class=cl>ls <span class=o>[</span>-1afhlnrSt<span class=o>]</span> <span class=o>[</span>path<span class=o>]</span>             Display remote directory listing
</span></span><span class=line><span class=cl>lumask <span class=nb>umask</span>                       Set <span class=nb>local</span> <span class=nb>umask</span> to <span class=s1>&#39;umask&#39;</span>
</span></span><span class=line><span class=cl>mkdir path                         Create remote directory
</span></span><span class=line><span class=cl>progress                           Toggle display of progress meter
</span></span><span class=line><span class=cl>put <span class=o>[</span>-afpR<span class=o>]</span> <span class=nb>local</span> <span class=o>[</span>remote<span class=o>]</span>         Upload file
</span></span><span class=line><span class=cl><span class=nb>pwd</span>                                Display remote working directory
</span></span><span class=line><span class=cl>quit                               Quit sftp
</span></span><span class=line><span class=cl>reget <span class=o>[</span>-fpR<span class=o>]</span> remote <span class=o>[</span>local<span class=o>]</span>        Resume download file
</span></span><span class=line><span class=cl>rename oldpath newpath             Rename remote file
</span></span><span class=line><span class=cl>reput <span class=o>[</span>-fpR<span class=o>]</span> <span class=nb>local</span> <span class=o>[</span>remote<span class=o>]</span>        Resume upload file
</span></span><span class=line><span class=cl>rm path                            Delete remote file
</span></span><span class=line><span class=cl>rmdir path                         Remove remote directory
</span></span><span class=line><span class=cl>symlink oldpath newpath            Symlink remote file
</span></span><span class=line><span class=cl>version                            Show SFTP version
</span></span><span class=line><span class=cl>!command                           Execute <span class=s1>&#39;command&#39;</span> in <span class=nb>local</span> shell
</span></span><span class=line><span class=cl>!                                  Escape to <span class=nb>local</span> shell
</span></span><span class=line><span class=cl>?                                  Synonym <span class=k>for</span> <span class=nb>help</span>
</span></span></code></pre></div><p> </p><h3 id=파일-업로드-테스트 class="relative group">파일 업로드 테스트 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%8c%8c%ec%9d%bc-%ec%97%85%eb%a1%9c%eb%93%9c-%ed%85%8c%ec%8a%a4%ed%8a%b8 aria-label=Anchor>#</a></span></h3><p>S3에 업로드를 테스트하기 위한 샘플 파일을 생성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;hello world.&#34;</span> &gt;&gt; helloworld.txt
</span></span></code></pre></div><p>SFTP 서버에 다시 접속합니다.<br>로컬 파일시스템의 현재 경로에 있는 파일 목록을 조회합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sftp&gt; lls .
</span></span><span class=line><span class=cl>helloworld.txt
</span></span></code></pre></div><p>방금 생성한 <code>helloworld.txt</code> 파일을 SFTP 서버에 업로드하겠습니다.<br>실제 파일이 저장되는 장소는 백엔드인 S3 버킷이라는 사실을 명심해야 합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sftp&gt; put helloworld.txt helloworld.txt
</span></span><span class=line><span class=cl>Uploading helloworld.txt to /rocket-x82q-sftp-bucket/alice/helloworld.txt
</span></span><span class=line><span class=cl>helloworld.txt                                                                                                                                                                      100%   <span class=m>13</span>     1.0KB/s   00:00
</span></span></code></pre></div><p><code>ls</code> 명령어로 파일이 S3에 업로드된 걸 확인할 수 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sftp&gt; ls
</span></span><span class=line><span class=cl>helloworld.txt  
</span></span></code></pre></div><p>SFTP 서버를 빠져나온 다음, AWS CLI에서 S3 버킷 안에 들어있는 오브젝트를 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sftp&gt; <span class=nb>exit</span>
</span></span><span class=line><span class=cl>$ aws s3 ls s3://rocket-x82q-sftp-bucket/alice/
</span></span><span class=line><span class=cl>2022-06-17 03:10:51         <span class=m>13</span> helloworld.txt
</span></span></code></pre></div><p>S3 버킷에 파일이 업로드된 걸 확인할 수 있습니다.</p><p> </p><h3 id=실습환경-정리 class="relative group">실습환경 정리 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%8b%a4%ec%8a%b5%ed%99%98%ea%b2%bd-%ec%a0%95%eb%a6%ac aria-label=Anchor>#</a></span></h3><p>실습이 종료된 후에는 비용 청구가 발생하는 걸 방지하기 위해 테라폼으로 생성한 리소스를 모두 삭제합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ terraform destroy
</span></span></code></pre></div><p>AWS Transfer Family의 SFTP 서버가 저렴한 비용은 아닙니다. 실습이 끝난 후에는 <strong>반드시</strong> 테라폼으로 생성한 모든 AWS 리소스를 삭제해주세요.</p><p> </p><h2 id=참고자료 class="relative group">참고자료 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%b0%b8%ea%b3%a0%ec%9e%90%eb%a3%8c aria-label=Anchor>#</a></span></h2><p><a href=https://aws.amazon.com/ko/aws-transfer-family/pricing/>AWS Transfer Family 요금</a></p><p>SFTP 엔드포인트 비용이 1시간당 $0.30 입니다. 굉장히 부담스러운 가격입니다.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><script src=https://utteranc.es/client.js repo=seyslee/seyslee.github.io issue-term=pathname label=blog-comment theme=github-dark crossorigin=anonymous async></script></footer></article><div class="absolute top-[100vh] ltr:right-0 rtl:left-0 w-12 pointer-events-none bottom-0"><a href=#the-top class="w-12 h-12 sticky pointer-events-auto top-[calc(100vh-5.5rem)] bg-neutral/50 dark:bg-neutral-800/50 backdrop-blur rounded-full text-xl flex items-center justify-center text-neutral-700 dark:text-neutral hover:text-primary-600 dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Younsung Lee</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://git.io/hugo-congo target=_blank rel="noopener noreferrer">Congo</a></p></div></div></footer></div></body></html>