<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>데이터독 disk metric error &#183; seyslee</title><meta name=title content="데이터독 disk metric error &#183; seyslee"><meta name=description content="seyslee"><link rel=canonical href=https://seyslee.github.io/blog/troubleshoot-datadog-disk-metric/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fff8ff4cdbe2bf80930c53b6e47a6d9826b914a8623246481ff09ff52ea48fcfb403d9ba1dc7bbc800a7ecb15298c468838a661dd8ebb3e9f46fdca239b38a30.css integrity="sha512-//j/TNviv4CTDFO25HptmCa5FKhiMkZIH/Cf9S6kj8+0A9m6Hce7yACn7LFSmMRog4pmHdjrs+n0b9yiObOKMA=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9947db70e5b36e741e53f8531bd734741b3fc7a688f7b5d749fc5433c48efc252f47bdf44e471570a550fc051b87712799014040e6349b38d64448b94e84e45a.js integrity="sha512-mUfbcOWzbnQeU/hTG9c0dBs/x6aI97XXSfxUM8SO/CUvR730TkcVcKVQ/AUbh3EnmQFAQOY0mzjWREi5ToTkWg==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="데이터독 disk metric error"><meta property="og:description" content="데이터독 에이전트에서 발생하는 disk metric error 이슈를 해결하는 방법을 소개합니다."><meta property="og:type" content="article"><meta property="og:url" content="https://seyslee.github.io/blog/troubleshoot-datadog-disk-metric/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-06-30T21:52:00+09:00"><meta property="article:modified_time" content="2022-06-30T22:55:22+09:00"><meta property="og:site_name" content="seyslee"><meta name=twitter:card content="summary"><meta name=twitter:title content="데이터독 disk metric error"><meta name=twitter:description content="데이터독 에이전트에서 발생하는 disk metric error 이슈를 해결하는 방법을 소개합니다."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blogs","name":"데이터독 disk metric error","headline":"데이터독 disk metric error","description":"데이터독 에이전트에서 발생하는 disk metric error 이슈를 해결하는 방법을 소개합니다.","abstract":"개요 # EC2 인스턴스에 설치된 데이터독 에이전트에서 Unable to get disk metrics .","inLanguage":"en","url":"https:\/\/seyslee.github.io\/blog\/troubleshoot-datadog-disk-metric\/","author":{"@type":"Person","name":"Younsung Lee"},"copyrightYear":"2022","dateCreated":"2022-06-30T21:52:00\u002b09:00","datePublished":"2022-06-30T21:52:00\u002b09:00","dateModified":"2022-06-30T22:55:22\u002b09:00","keywords":["monitoring","datadog"],"mainEntityOfPage":"true","wordCount":"941"}]</script><meta name=author content="Younsung Lee"><link href=mailto:ivecloudblack@gmail.com rel=me><link href=https://github.com/seyslee rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>seyslee</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/blog/ title=Blogs>post</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>tag</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">데이터독 disk metric error</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-06-30 21:52:00 +0900 +0900">Jun 30, 2022</time></div><div class="my-1 text-xs text-neutral-500 dark:text-neutral-400"><a href=/tags/monitoring/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">monitoring</a>
<a href=/tags/datadog/ class="px-1 py-[1px] border rounded-md border-neutral-200 dark:border-neutral-600 hover:border-primary-300 hover:text-primary-700 dark:hover:border-primary-600 dark:hover:text-primary-400">datadog</a></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><a href=#개요>개요</a></li><li><a href=#증상>증상</a></li><li><a href=#환경>환경</a></li><li><a href=#원인>원인</a></li><li><a href=#해결방법>해결방법</a></li><li><a href=#상세-해결방법>상세 해결방법</a><ul><li><a href=#설정파일-확인>설정파일 확인</a></li><li><a href=#설정파일-변경>설정파일 변경</a></li><li><a href=#에이전트-재시작>에이전트 재시작</a></li><li><a href=#테스트>테스트</a></li></ul></li><li><a href=#참고자료>참고자료</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><h2 id=개요 class="relative group">개요 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b0%9c%ec%9a%94 aria-label=Anchor>#</a></span></h2><p>EC2 인스턴스에 설치된 데이터독 에이전트에서 <code>Unable to get disk metrics ... [Error 13] Permission denied</code> 에러가 지속 발생할 때 해결하는 방법을 소개합니다.</p><p> </p><h2 id=증상 class="relative group">증상 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%a6%9d%ec%83%81 aria-label=Anchor>#</a></span></h2><p>EC2 인스턴스에서 데이터독 에이전트 v7.37.1 를 사용중입니다.<br>도커 컨테이너의 디스크 메트릭 관련 에러 로그가 지속 발생하는 증상입니다.</p><p> </p><p><strong>데이터독 에이전트 로그</strong><br>증상이 발생할 때 출력되는 데이터독 에이전트의 로그 내용은 다음과 같습니다.</p><p>문제되는 로그의 레벨은 <code>Warning</code>이고, 데이터독 대시보드에 보이는 메트릭 수집 자체에는 영향을 주지 않지만, 어드민 관점에서 불필요하게 반복 발생하는 로그는 필수 제거 대상입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tail -10 agent.log
</span></span><span class=line><span class=cl>2022-06-30 01:51:38 UTC <span class=p>|</span> CORE <span class=p>|</span> WARN <span class=p>|</span> <span class=o>(</span>pkg/collector/python/datadog_agent.go:124 in LogMessage<span class=o>)</span> <span class=p>|</span> disk:e1dffb2bef34567f <span class=p>|</span> <span class=o>(</span>disk.py:135<span class=o>)</span> <span class=p>|</span> Unable to get disk metrics <span class=k>for</span> /var/lib/docker/containers/471a5aa5d8266ade61d358c1024d704a6b0a3eb7d75f442a01aee362c38cc5dd/mounts/shm: <span class=o>[</span>Errno 13<span class=o>]</span> Permission denied: <span class=s1>&#39;/var/lib/docker/containers/471a5aa5d8266ade61d358c1024d704a6b0a3eb7d75f442a01aee362c38cc5dd/mounts/shm&#39;</span>. You can exclude this mountpoint in the settings <span class=k>if</span> it is invalid.
</span></span><span class=line><span class=cl>2022-06-30 01:51:38 UTC <span class=p>|</span> CORE <span class=p>|</span> WARN <span class=p>|</span> <span class=o>(</span>pkg/collector/python/datadog_agent.go:124 in LogMessage<span class=o>)</span> <span class=p>|</span> disk:e1dffb2bef34567f <span class=p>|</span> <span class=o>(</span>disk.py:135<span class=o>)</span> <span class=p>|</span> Unable to get disk metrics <span class=k>for</span> /run/docker/netns/0f39da799d9d: <span class=o>[</span>Errno 13<span class=o>]</span> Permission denied: <span class=s1>&#39;/run/docker/netns/0f39da799d9d&#39;</span>. You can exclude this mountpoint in the settings <span class=k>if</span> it is invalid.
</span></span><span class=line><span class=cl>2022-06-30 01:51:38 UTC <span class=p>|</span> CORE <span class=p>|</span> WARN <span class=p>|</span> <span class=o>(</span>pkg/collector/python/datadog_agent.go:124 in LogMessage<span class=o>)</span> <span class=p>|</span> disk:e1dffb2bef34567f <span class=p>|</span> <span class=o>(</span>disk.py:135<span class=o>)</span> <span class=p>|</span> Unable to get disk metrics <span class=k>for</span> /var/lib/docker/containers/0c3c6d543bfe9dc3bde28599abc0e06e599775a720bc5b8b999a0154b413100d/mounts/shm: <span class=o>[</span>Errno 13<span class=o>]</span> Permission denied: <span class=s1>&#39;/var/lib/docker/containers/0c3c6d543bfe9dc3bde28599abc0e06e599775a720bc5b8b999a0154b413100d/mounts/shm&#39;</span>. You can exclude this mountpoint in the settings <span class=k>if</span> it is invalid.
</span></span><span class=line><span class=cl>2022-06-30 01:51:38 UTC <span class=p>|</span> CORE <span class=p>|</span> WARN <span class=p>|</span> <span class=o>(</span>pkg/collector/python/datadog_agent.go:124 in LogMessage<span class=o>)</span> <span class=p>|</span> disk:e1dffb2bef34567f <span class=p>|</span> <span class=o>(</span>disk.py:135<span class=o>)</span> <span class=p>|</span> Unable to get disk metrics <span class=k>for</span> /run/docker/netns/de516beeee44: <span class=o>[</span>Errno 13<span class=o>]</span> Permission denied: <span class=s1>&#39;/run/docker/netns/de516beeee44&#39;</span>. You can exclude this mountpoint in the settings <span class=k>if</span> it is invalid.
</span></span></code></pre></div><p>위와 같은 에러 메세지가 끊임없이 반복 발생하는 증상입니다.</p><p>그러나 데이터독 대시보드에 접속해서 해당 인스턴스를 확인해보면 디스크 메트릭을 포함한 모든 메트릭을 정상적으로 수집해오고 있는 상황이었습니다.</p><p><figure><img class="my-0 rounded-md" src=./1.png alt="Datadog dashboard"></figure></p><p> </p><h2 id=환경 class="relative group">환경 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%99%98%ea%b2%bd aria-label=Anchor>#</a></span></h2><p>문제가 발생한 EC2 Instance의 환경은 다음과 같습니다.</p><p><figure><img class="my-0 rounded-md" src=./2.png alt="Infra Architecture"></figure></p><p>EC2 인스턴스 내부에서 여러 개의 Docker 컨테이너가 동작하고 있습니다.</p><ul><li><strong>Docker</strong> : Docker CE 20.10.7 (linux/amd64)</li><li><strong>OS</strong> : Ubuntu 20.04.3 LTS</li><li><strong>Datadog Agent</strong> : 7.37.1</li></ul><p> </p><h2 id=원인 class="relative group">원인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%9b%90%ec%9d%b8 aria-label=Anchor>#</a></span></h2><p>EC2 안에서 돌고있는 도커 컨테이너에 디스크 메트릭을 수집하려고 계속 시도하면서 에러 메세지가 발생합니다.</p><p> </p><h2 id=해결방법 class="relative group">해결방법 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%95%b4%ea%b2%b0%eb%b0%a9%eb%b2%95 aria-label=Anchor>#</a></span></h2><p>데이터독 에이전트 설정에서 도커 컨테이너 관련 파일시스템과 마운트 포인트를 명시적으로 제외하면 해결됩니다.</p><p> </p><h2 id=상세-해결방법 class="relative group">상세 해결방법 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%83%81%ec%84%b8-%ed%95%b4%ea%b2%b0%eb%b0%a9%eb%b2%95 aria-label=Anchor>#</a></span></h2><h3 id=설정파일-확인 class="relative group">설정파일 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%84%a4%ec%a0%95%ed%8c%8c%ec%9d%bc-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h3><p>데이터독 에이전트의 설정파일 경로를 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ datadog-agent configcheck
</span></span></code></pre></div><p>중간에 <code>disk check</code> 부분에서 Config 경로를 확인할 수 있습니다.<br>설정파일의 기본경로는 다음과 같습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>===</span> disk <span class=nv>check</span> <span class=o>===</span>
</span></span><span class=line><span class=cl>Configuration provider: file
</span></span><span class=line><span class=cl>Configuration source: file:/etc/datadog-agent/conf.d/disk.d/conf.yaml
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>~
</span></span><span class=line><span class=cl><span class=o>===</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p> </p><p>디스크 메트릭 설정파일의 내용을 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat /etc/datadog-agent/conf.d/disk.d/conf.yaml
</span></span></code></pre></div><p>기본적으로 아래와 같이 설정되어 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>init_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>use_mount</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>excluded_filesystems</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>autofs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/proc/sys/fs/binfmt_misc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/host/proc/sys/fs/binfmt_misc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># mount_point_exclude:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   - /proc/sys/fs/binfmt_misc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   - /dev/sde</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   - &#39;[FJ]:&#39;</span><span class=w>
</span></span></span></code></pre></div><p> </p><h3 id=설정파일-변경 class="relative group">설정파일 변경 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%84%a4%ec%a0%95%ed%8c%8c%ec%9d%bc-%eb%b3%80%ea%b2%bd aria-label=Anchor>#</a></span></h3><p>디스크 메트릭 설정파일을 변경합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ vi /etc/datadog-agent/conf.d/disk.d/conf.yaml</span><span class=w>
</span></span></span></code></pre></div><p> </p><p>변경내용은 다음과 같습니다.</p><ul><li><code>excluded_filesystems</code>에 <code>none</code>, <code>shm</code>, <code>nsfs</code>를 추가합니다.</li><li><code>mount_point_exclude</code> 부분을 주석해제합니다.</li><li><code>mount_point_exclude</code>에 도커 관련 마운트 포인트를 추가해서 디스크 메트릭 수집에서 제외시킵니다.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>init_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>instances</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>use_mount</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>excluded_filesystems</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Add configs to solve error log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># `Unable to get disk metrics`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># [Error 13] Permission denied.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># == Additional config start ==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>none</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>shm</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>nsfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># == Additional config end ==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>autofs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/proc/sys/fs/binfmt_misc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/host/proc/sys/fs/binfmt_misc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mount_point_exclude</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Add configs to solve error log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># `Unable to get disk metrics`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># [Error 13] Permission denied.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># == Additonal config start ==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/var/lib/docker/(containers|overlay2)/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/run/docker/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/sys/kernel/debug/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/run/user/1000/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># == Additional config end ==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/proc/sys/fs/binfmt_misc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>/dev/sde</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;[FJ]:&#39;</span><span class=w>
</span></span></span></code></pre></div><p>작성할 때 <code>#</code> 주석 부분은 안 넣으셔도 됩니다.</p><p> </p><h3 id=에이전트-재시작 class="relative group">에이전트 재시작 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%97%90%ec%9d%b4%ec%a0%84%ed%8a%b8-%ec%9e%ac%ec%8b%9c%ec%9e%91 aria-label=Anchor>#</a></span></h3><p>변경된 설정을 적용하기 위해 데이터독 에이전트를 재시작합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ systemctl restart datadog-agent
</span></span></code></pre></div><p> </p><p>재시작 이후 데이터독 에이전트의 상태를 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ systemctl status datadog-agent
</span></span></code></pre></div><p> </p><h3 id=테스트 class="relative group">테스트 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%85%8c%ec%8a%a4%ed%8a%b8 aria-label=Anchor>#</a></span></h3><p>추가한 디스크 메트릭 설정이 잘 적용되었는지 점검합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ datadog-agent configcheck
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>===</span> disk <span class=nv>check</span> <span class=o>===</span>
</span></span><span class=line><span class=cl>Configuration provider: file
</span></span><span class=line><span class=cl>Configuration source: file:/etc/datadog-agent/conf.d/disk.d/conf.yaml
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>excluded_filesystems:
</span></span><span class=line><span class=cl>- none
</span></span><span class=line><span class=cl>- shm
</span></span><span class=line><span class=cl>- nsfs
</span></span><span class=line><span class=cl>- autofs
</span></span><span class=line><span class=cl>- /proc/sys/fs/binfmt_misc
</span></span><span class=line><span class=cl>- /host/proc/sys/fs/binfmt_misc
</span></span><span class=line><span class=cl>mount_point_exclude:
</span></span><span class=line><span class=cl>- /var/lib/docker/<span class=o>(</span>containers<span class=p>|</span>overlay2<span class=o>)</span>/
</span></span><span class=line><span class=cl>- /run/docker/
</span></span><span class=line><span class=cl>- /sys/kernel/debug/
</span></span><span class=line><span class=cl>- /run/user/1000/
</span></span><span class=line><span class=cl>- /proc/sys/fs/binfmt_misc
</span></span><span class=line><span class=cl>- /dev/sde
</span></span><span class=line><span class=cl>- <span class=s1>&#39;[FJ]:&#39;</span>
</span></span><span class=line><span class=cl>use_mount: <span class=nb>false</span>
</span></span><span class=line><span class=cl>~
</span></span><span class=line><span class=cl><span class=o>===</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>정상적으로 적용된 걸 확인할 수 있습니다.</p><p> </p><p>다시 데이터독 에이전트의 로그를 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ tail -f /var/log/datadog/agent.log
</span></span><span class=line><span class=cl>2022-06-30 02:16:39 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:38 in CheckStarted<span class=o>)</span> <span class=p>|</span> check:io <span class=p>|</span> Running check...
</span></span><span class=line><span class=cl>2022-06-30 02:16:39 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:57 in CheckFinished<span class=o>)</span> <span class=p>|</span> check:io <span class=p>|</span> Done running check, next runs will be logged every <span class=m>500</span> runs
</span></span><span class=line><span class=cl>2022-06-30 02:16:40 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:38 in CheckStarted<span class=o>)</span> <span class=p>|</span> check:cpu <span class=p>|</span> Running check...
</span></span><span class=line><span class=cl>2022-06-30 02:16:40 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:57 in CheckFinished<span class=o>)</span> <span class=p>|</span> check:cpu <span class=p>|</span> Done running check, next runs will be logged every <span class=m>500</span> runs
</span></span><span class=line><span class=cl>2022-06-30 02:16:45 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:38 in CheckStarted<span class=o>)</span> <span class=p>|</span> check:network <span class=p>|</span> Running check...
</span></span><span class=line><span class=cl>2022-06-30 02:16:45 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:57 in CheckFinished<span class=o>)</span> <span class=p>|</span> check:network <span class=p>|</span> Done running check, next runs will be logged every <span class=m>500</span> runs
</span></span><span class=line><span class=cl>2022-06-30 02:16:46 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:38 in CheckStarted<span class=o>)</span> <span class=p>|</span> check:load <span class=p>|</span> Running check...
</span></span><span class=line><span class=cl>2022-06-30 02:16:46 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:57 in CheckFinished<span class=o>)</span> <span class=p>|</span> check:load <span class=p>|</span> Done running check, next runs will be logged every <span class=m>500</span> runs
</span></span><span class=line><span class=cl>2022-06-30 02:16:47 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:38 in CheckStarted<span class=o>)</span> <span class=p>|</span> check:file_handle <span class=p>|</span> Running check...
</span></span><span class=line><span class=cl>2022-06-30 02:16:47 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:57 in CheckFinished<span class=o>)</span> <span class=p>|</span> check:file_handle <span class=p>|</span> Done running check, next runs will be logged every <span class=m>500</span> runs
</span></span><span class=line><span class=cl>2022-06-30 02:16:47 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/collector/worker/check_logger.go:57 in CheckFinished<span class=o>)</span> <span class=p>|</span> check:file_handle <span class=p>|</span> Done running check, next runs will be logged every <span class=m>500</span> runs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>... <span class=m>4</span> minutes later ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2022-06-30 02:20:31 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/serializer/serializer.go:388 in sendMetadata<span class=o>)</span> <span class=p>|</span> Sent metadata payload, size <span class=o>(</span>raw/compressed<span class=o>)</span>: 1802/496 bytes.
</span></span><span class=line><span class=cl>2022-06-30 02:20:33 UTC <span class=p>|</span> CORE <span class=p>|</span> INFO <span class=p>|</span> <span class=o>(</span>pkg/serializer/serializer.go:412 in SendProcessesMetadata<span class=o>)</span> <span class=p>|</span> Sent processes metadata payload, size: <span class=m>1458</span> bytes.
</span></span></code></pre></div><p>디스크 메트릭 제외 설정을 추가로 적용한 이후부터 디스크 메트릭 수집 관련 에러로그가 사라진 걸 확인할 수 있습니다.</p><p> </p><h2 id=참고자료 class="relative group">참고자료 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%b0%b8%ea%b3%a0%ec%9e%90%eb%a3%8c aria-label=Anchor>#</a></span></h2><p>제 경우는 아래 솔루션을 그대로 적용해서 문제를 해결했습니다.</p><p><a href=https://github.com/DataDog/dd-agent/issues/2932#issuecomment-647088933>DataDog/dd-agent Issue#2932</a></p></div></section><footer class="pt-8 max-w-prose print:hidden"><script src=https://utteranc.es/client.js repo=seyslee/seyslee.github.io issue-term=pathname label=blog-comment theme=github-dark crossorigin=anonymous async></script></footer></article></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Younsung Lee</p></div></div></footer></div></body></html>