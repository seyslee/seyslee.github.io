<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>쿠버네티스 cordon, drain &#183; seyslee</title><meta name=title content="쿠버네티스 cordon, drain &#183; seyslee"><meta name=description content="seyslee"><link rel=canonical href=https://seyslee.github.io/blog/k8s/cordon-and-drain/><link type=text/css rel=stylesheet href=/css/main.bundle.min.980311a18ad0b55ec626a015b02d8161dc5f9d2c385a9806100e43c16f86e2fd1b824521ff0017c49f7a84d11834247d5741e87d58473a289ef870e9f3d13c02.css integrity="sha512-mAMRoYrQtV7GJqAVsC2BYdxfnSw4WpgGEA5DwW+G4v0bgkUh/wAXxJ96hNEYNCR9V0HofVhHOiie+HDp89E8Ag=="><script type=text/javascript src=/js/appearance.min.12e98742cd283574d030a7fe55f29597df4ee214f7ff7075b4d19a64d046a602753c715295550be7899b661619cec89c679049d36c624681671a8013c1249896.js integrity="sha512-EumHQs0oNXTQMKf+VfKVl99O4hT3/3B1tNGaZNBGpgJ1PHFSlVUL54mbZhYZzsicZ5BJ02xiRoFnGoATwSSYlg=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9ae0a991bb442898e9bc60cf318b4de3ff878325ff3821625a5564b32b2f66aec0e7f7d0e00ca3ac7df59d9f01c18c88b6bdd213184f86ac9ce06d7bdffbadf8.js integrity="sha512-muCpkbtEKJjpvGDPMYtN4/+HgyX/OCFiWlVksysvZq7A5/fQ4AyjrH31nZ8BwYyItr3SExhPhqyc4G173/ut+A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="쿠버네티스 cordon, drain"><meta property="og:description" content="쿠버네티스 노드의 pod 스케줄링을 제어하는 명령어인 cordon, drain, uncordon에 대해 자세히 알아본다."><meta property="og:type" content="article"><meta property="og:url" content="https://seyslee.github.io/blog/k8s/cordon-and-drain/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-11-14T15:26:40+09:00"><meta property="article:modified_time" content="2021-11-14T16:15:40+09:00"><meta property="og:site_name" content="seyslee"><meta name=twitter:card content="summary"><meta name=twitter:title content="쿠버네티스 cordon, drain"><meta name=twitter:description content="쿠버네티스 노드의 pod 스케줄링을 제어하는 명령어인 cordon, drain, uncordon에 대해 자세히 알아본다."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blogs","name":"쿠버네티스 cordon, drain","headline":"쿠버네티스 cordon, drain","description":"쿠버네티스 노드의 pod 스케줄링을 제어하는 명령어인 cordon, drain, uncordon에 대해 자세히 알아본다.","abstract":"개요 #    cordon, uncordon, drain 명령어를 통해 쿠버네티스 클러스터를 구성하는 노드의 파드 스케줄링을 제어할 수 있다.","inLanguage":"en","url":"https:\/\/seyslee.github.io\/blog\/k8s\/cordon-and-drain\/","author":{"@type":"Person","name":"Younsung Lee"},"copyrightYear":"2021","dateCreated":"2021-11-14T15:26:40\u002b09:00","datePublished":"2021-11-14T15:26:40\u002b09:00","dateModified":"2021-11-14T16:15:40\u002b09:00","keywords":["devops","kubernetes"],"mainEntityOfPage":"true","wordCount":"1067"}]</script><meta name=author content="Younsung Lee"><link href=mailto:ivecloudblack@gmail.com rel=me><link href=https://github.com/seyslee rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>seyslee</a></div><nav><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/blog/ title=Blogs>post</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>tag</a></li></ul></nav></header><div class=relative><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">쿠버네티스 cordon, drain</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-11-14 15:26:40 +0900 +0900">Nov 14, 2021</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2021-11-14 16:15:40 +0900 +0900">Updated: Nov 14, 2021</time></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#개요>개요</a></li><li><a href=#환경>환경</a></li><li><a href=#본론>본론</a><ul><li><a href=#cordon>cordon</a><ul><li><a href=#설정방법>설정방법</a></li><li><a href=#예제>예제</a></li></ul></li><li><a href=#drain>drain</a><ul><li><a href=#설정방법-1>설정방법</a></li><li><a href=#예제-1>예제</a></li></ul></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><h1 id=개요 class="relative group">개요 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b0%9c%ec%9a%94 aria-label=Anchor>#</a></span></h1><p><figure><img class="my-0 rounded-md" src=./1.jpg alt></figure></p><p><code>cordon</code>, <code>uncordon</code>, <code>drain</code> 명령어를 통해 쿠버네티스 클러스터를 구성하는 노드의 파드 스케줄링을 제어할 수 있다. 주로 노드의 패치 작업이나 하드웨어 유지보수 작업 시에 파드 스케줄링을 사용한다.</p><br><h1 id=환경 class="relative group">환경 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%99%98%ea%b2%bd aria-label=Anchor>#</a></span></h1><ul><li><strong>Hardware</strong> : MacBook Pro (13", M1, 2020)</li><li><strong>OS</strong> : macOS Monterey 12.0.1</li><li><strong>Docker Desktop 4.1.1</strong> (쿠버네티스 기능 활성화됨)</li><li><strong>minikube v.1.24.0</strong> (Homebrew로 설치)<ul><li><strong>멀티노드 구성</strong> : 1대의 마스터 노드(Control Plane) + 3대의 워커 노드</li></ul></li></ul><br><h1 id=본론 class="relative group">본론 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%b3%b8%eb%a1%a0 aria-label=Anchor>#</a></span></h1><h2 id=cordon class="relative group">cordon <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cordon aria-label=Anchor>#</a></span></h2><p><code>kubectl cordon</code>은 지정한 노드에 이미 배포된 Pod는 그대로 유지하면서 이후 추가적인 Pod 스케줄링에서 제외하는 명령어이다.</p><p>cordon 설정된 시점 이후부터 해당 노드에는 추가로 pod가 배포되지 않는다.</p><br><h3 id=설정방법 class="relative group">설정방법 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%84%a4%ec%a0%95%eb%b0%a9%eb%b2%95 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl cordon &lt;노드 이름&gt;
</span></span></code></pre></div><br><h3 id=예제 class="relative group">예제 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%98%88%ec%a0%9c aria-label=Anchor>#</a></span></h3><h4 id=노드-확인 class="relative group">노드 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%85%b8%eb%93%9c-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get no
</span></span><span class=line><span class=cl>NAME        STATUS                     ROLES                  AGE     VERSION
</span></span><span class=line><span class=cl>mnlab       Ready,SchedulingDisabled   control-plane,master   2d16h   v1.22.3
</span></span><span class=line><span class=cl>mnlab-m02   Ready                      &lt;none&gt;                 43s     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m03   Ready                      &lt;none&gt;                 29s     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m04   Ready                      &lt;none&gt;                 16s     v1.22.3
</span></span></code></pre></div><p>현재 시나리오에는 클러스터 노드 4대(Master node 1 + Worker node 3)가 존재한다.</p><br><h4 id=cordon-설정 class="relative group">cordon 설정 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cordon-%ec%84%a4%ec%a0%95 aria-label=Anchor>#</a></span></h4><p><code>mnlab-m04</code> 노드에 cordon을 설정했다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl cordon mnlab-m04
</span></span><span class=line><span class=cl>node/mnlab-m04 cordoned
</span></span></code></pre></div><br><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get no
</span></span><span class=line><span class=cl>NAME        STATUS                     ROLES                  AGE     VERSION
</span></span><span class=line><span class=cl>mnlab       Ready,SchedulingDisabled   control-plane,master   2d17h   v1.22.3
</span></span><span class=line><span class=cl>mnlab-m02   Ready                      &lt;none&gt;                 12m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m03   Ready                      &lt;none&gt;                 11m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m04   Ready,SchedulingDisabled   &lt;none&gt;                 11m     v1.22.3
</span></span></code></pre></div><p><code>cordon</code> 처리한 <code>mnlab-m04</code> 노드가 스케줄링 비활성화(<code>SchedulingDisabled</code>) 상태로 빠졌다.</p><br><h4 id=deployment-생성 class="relative group">deployment 생성 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#deployment-%ec%83%9d%ec%84%b1 aria-label=Anchor>#</a></span></h4><p>이제 <code>mnlab-m04</code> 노드에 pod가 배포 안되는지 직접 확인하기 위해 deployment를 생성해본다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat deploy-nginx.yaml
</span></span><span class=line><span class=cl>apiVersion: apps/v1
</span></span><span class=line><span class=cl>kind: Deployment            <span class=c1># 타입은 Deployment</span>
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  name: nginx-deployment
</span></span><span class=line><span class=cl>  labels:
</span></span><span class=line><span class=cl>    app: nginx
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  replicas: <span class=m>5</span>               <span class=c1># 5개의 Pod를 유지한다.</span>
</span></span><span class=line><span class=cl>  selector:                 <span class=c1># Deployment에 속하는 Pod의 조건</span>
</span></span><span class=line><span class=cl>    matchLabels:            <span class=c1># label의 app 속성의 값이 nginx 인 Pod를 찾아라.</span>
</span></span><span class=line><span class=cl>      app: nginx
</span></span><span class=line><span class=cl>  template:
</span></span><span class=line><span class=cl>    metadata:
</span></span><span class=line><span class=cl>      labels:
</span></span><span class=line><span class=cl>        app: nginx          <span class=c1># labels 필드를 사용해서 app: nginx 레이블을 붙힘</span>
</span></span><span class=line><span class=cl>    spec:
</span></span><span class=line><span class=cl>      containers:           <span class=c1># container에 대한 정의</span>
</span></span><span class=line><span class=cl>      - name: nginx         <span class=c1># container의 이름</span>
</span></span><span class=line><span class=cl>        image: nginx:1.7.9  <span class=c1># Docker Hub에 업로드된 nginx:1.7.9 이미지를 사용</span>
</span></span><span class=line><span class=cl>        ports:
</span></span><span class=line><span class=cl>        - containerPort: <span class=m>80</span>
</span></span></code></pre></div><p>5개의 nginx pod를 생성하는 deployment yaml 파일이다.</p><p>컨테이너 이미지는 Docker Hub에 공식 등록된 <code>nginx:1.7.9</code>를 사용한다.</p><br><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f deploy-nginx.yaml
</span></span><span class=line><span class=cl>deployment.apps/nginx-deployment created
</span></span></code></pre></div><p>작성한 yaml 파일로 deployment를 생성했다.</p><br><h4 id=배포-결과확인 class="relative group">배포 결과확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%b0%b0%ed%8f%ac-%ea%b2%b0%ea%b3%bc%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>deployment로 pod 5대를 생성했지만 <code>mnlab-m04</code> 노드에는 pod가 1대도 배포되지 않았다!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get all -o wide
</span></span><span class=line><span class=cl>NAME                                    READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-5jz9r   1/1     Running   <span class=m>0</span>          12s   10.244.1.3   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-grwwc   1/1     Running   <span class=m>0</span>          12s   10.244.2.3   mnlab-m03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-pmsfr   1/1     Running   <span class=m>0</span>          12s   10.244.2.2   mnlab-m03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-qwnht   1/1     Running   <span class=m>0</span>          12s   10.244.1.4   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-xc8tv   1/1     Running   <span class=m>0</span>          12s   10.244.1.2   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>   AGE   SELECTOR
</span></span><span class=line><span class=cl>service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   15h   &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES        SELECTOR
</span></span><span class=line><span class=cl>deployment.apps/nginx-deployment   5/5     <span class=m>5</span>            <span class=m>5</span>           12s   nginx        nginx:1.7.9   <span class=nv>app</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                          DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES        SELECTOR
</span></span><span class=line><span class=cl>replicaset.apps/nginx-deployment-5d59d67564   <span class=m>5</span>         <span class=m>5</span>         <span class=m>5</span>       12s   nginx        nginx:1.7.9   <span class=nv>app</span><span class=o>=</span>nginx,pod-template-hash<span class=o>=</span>5d59d67564
</span></span></code></pre></div><br><h4 id=cordon-해제 class="relative group">cordon 해제 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#cordon-%ed%95%b4%ec%a0%9c aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl uncordon mnlab-m04
</span></span><span class=line><span class=cl>node/mnlab-m04 uncordoned
</span></span></code></pre></div><p><code>mnlab-m04</code> 노드의 cordon이 해제되었다.</p><br><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get no
</span></span><span class=line><span class=cl>NAME        STATUS                     ROLES                  AGE     VERSION
</span></span><span class=line><span class=cl>mnlab       Ready,SchedulingDisabled   control-plane,master   2d17h   v1.22.3
</span></span><span class=line><span class=cl>mnlab-m02   Ready                      &lt;none&gt;                 15m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m03   Ready                      &lt;none&gt;                 14m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m04   Ready                      &lt;none&gt;                 14m     v1.22.3
</span></span></code></pre></div><p>이후부터 <code>mnlab-m04</code> 노드에 pod가 다시 배포될 수 있다.</p><br><h2 id=drain class="relative group">drain <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#drain aria-label=Anchor>#</a></span></h2><p><code>kubectl drain</code>은 지정한 노드에 이미 배포된 pod를 제거한 후 다른 노드에 재배치하는 명령어이다. (참고로 쿠버네티스에서 pod를 옮기는 기능은 존재하지 않는다. 파드를 다른 노드에 다시 생성할 뿐이다.)</p><p>drain 설정된 노드에는 pod가 다른 노드로 재배치된 후 스케줄링이 비활성화(<code>SchedulingDisabled</code>)되어 이후 어떠한 pod도 배포되지 않는다. 노드의 하드웨어 작업이나 리부팅이 필요할 경우, 먼저 drain으로 pod를 다른 노드로 재배치한 후 원하는 유지보수 작업을 수행하면 된다.</p><br><p><strong>주의사항</strong> : ReplicationController, ReplicaSet, Deployment, StatefulSet 등의 컨트롤러에서 관리하지 않는 <u>개별 파드(Static pod)의 경우 drain 실행시 다른 노드에 재배포 되지않고 삭제만 발생하므로 데이터가 손실될 수 있다.</u></p><br><p><strong>drain을 실행하면 발생하는 일</strong></p><ol><li>해당 노드에 더 이상 pod 배포를 하지 않도록 스케줄링 비활성화 (<code>SchedulingDisabled</code>)</li><li>노드에 이미 배포된 pod를 모두 삭제</li><li>삭제된 pod는 새로운 정상 노드에서 재생성됨</li></ol><p>drain은 cordon 기능에 pod를 다른 노드로 재배치하는 기능 2개가 결합된 거라고 이해하면 쉽다.</p><br><h3 id=설정방법-1 class="relative group">설정방법 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%84%a4%ec%a0%95%eb%b0%a9%eb%b2%95-1 aria-label=Anchor>#</a></span></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl drain &lt;노드 이름&gt; --ignore-daemonsets
</span></span></code></pre></div><br><h3 id=예제-1 class="relative group">예제 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%98%88%ec%a0%9c-1 aria-label=Anchor>#</a></span></h3><h4 id=노드-확인-1 class="relative group">노드 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%85%b8%eb%93%9c-%ed%99%95%ec%9d%b8-1 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get no
</span></span><span class=line><span class=cl>NAME        STATUS                     ROLES                  AGE     VERSION
</span></span><span class=line><span class=cl>mnlab       Ready,SchedulingDisabled   control-plane,master   2d17h   v1.22.3
</span></span><span class=line><span class=cl>mnlab-m02   Ready                      &lt;none&gt;                 29m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m03   Ready                      &lt;none&gt;                 28m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m04   Ready                      &lt;none&gt;                 28m     v1.22.3
</span></span></code></pre></div><p>현재 시나리오에는 클러스터 노드 4대(Master node 1 + Worker node 3)가 존재한다.</p><br><h4 id=deployment-배포 class="relative group">deployment 배포 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#deployment-%eb%b0%b0%ed%8f%ac aria-label=Anchor>#</a></span></h4><p>cordon 예제에서 쓴 deployment를 똑같이 배포해놓았다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get all -o wide
</span></span><span class=line><span class=cl>NAME                                    READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-2jdjt   1/1     Running   <span class=m>0</span>          6s    10.244.1.7   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-4qjvt   1/1     Running   <span class=m>0</span>          6s    10.244.2.7   mnlab-m03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-6qjg5   1/1     Running   <span class=m>0</span>          6s    10.244.3.3   mnlab-m04   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-j78cp   1/1     Running   <span class=m>0</span>          6s    10.244.2.8   mnlab-m03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-j8wft   1/1     Running   <span class=m>0</span>          6s    10.244.1.8   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>   AGE   SELECTOR
</span></span><span class=line><span class=cl>service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   15h   &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES        SELECTOR
</span></span><span class=line><span class=cl>deployment.apps/nginx-deployment   5/5     <span class=m>5</span>            <span class=m>5</span>           6s    nginx        nginx:1.7.9   <span class=nv>app</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                          DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES        SELECTOR
</span></span><span class=line><span class=cl>replicaset.apps/nginx-deployment-5d59d67564   <span class=m>5</span>         <span class=m>5</span>         <span class=m>5</span>       6s    nginx        nginx:1.7.9   <span class=nv>app</span><span class=o>=</span>nginx,pod-template-hash<span class=o>=</span>5d59d67564
</span></span></code></pre></div><p>5개의 pod가 <code>mnlab-m02</code>, <code>mnlab-m03</code>, <code>mnlab-m04</code> 노드에 골고루 배포되어 있는 상태이다. 이 상태에서 <code>mnlab-m04</code> 노드를 drain 해본다.</p><br><h4 id=drain-1 class="relative group">drain <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#drain-1 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl drain mnlab-m04 --ignore-daemonsets
</span></span><span class=line><span class=cl>node/mnlab-m04 cordoned
</span></span><span class=line><span class=cl>WARNING: ignoring DaemonSet-managed Pods: kube-system/kindnet-jgdz8, kube-system/kube-proxy-9fxn7
</span></span><span class=line><span class=cl>evicting pod default/nginx-deployment-5d59d67564-6qjg5
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-6qjg5 evicted
</span></span><span class=line><span class=cl>node/mnlab-m04 evicted
</span></span></code></pre></div><p>현재 시나리오 기준으로 Worker node마다 시스템 관련 Pod인 <code>kindnet</code>과 <code>kube-proxy</code>가 존재한다.</p><p>drain 실행시 <code>--ignore-daemonsets</code> 옵션을 줘서 데몬셋에 의해 생성된 시스템 Pod는 drain에서 제외한다.</p><br><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get no
</span></span><span class=line><span class=cl>NAME        STATUS                     ROLES                  AGE     VERSION
</span></span><span class=line><span class=cl>mnlab       Ready,SchedulingDisabled   control-plane,master   2d17h   v1.22.3
</span></span><span class=line><span class=cl>mnlab-m02   Ready                      &lt;none&gt;                 31m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m03   Ready                      &lt;none&gt;                 31m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m04   Ready,SchedulingDisabled   &lt;none&gt;                 31m     v1.22.3
</span></span></code></pre></div><p><code>mnlab-m04</code> 노드가 스케줄링 비활성화 상태(<code>SchedulingDisabled</code>)로 빠졌다. 더 이상 해당 노드에 pod가 스케줄링되어 생성되지 않는다는 의미이다.</p><br><h4 id=결과확인 class="relative group">결과확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b2%b0%ea%b3%bc%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p><code>mnlab-m04</code> 노드에 있던 pod 1대가 삭제된 후 다른 노드로 재배포되었다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get all -o wide
</span></span><span class=line><span class=cl>NAME                                    READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-2jdjt   1/1     Running   <span class=m>0</span>          91s   10.244.1.7   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-4qjvt   1/1     Running   <span class=m>0</span>          91s   10.244.2.7   mnlab-m03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-j78cp   1/1     Running   <span class=m>0</span>          91s   10.244.2.8   mnlab-m03   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-j8wft   1/1     Running   <span class=m>0</span>          91s   10.244.1.8   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>pod/nginx-deployment-5d59d67564-nn699   1/1     Running   <span class=m>0</span>          20s   10.244.1.9   mnlab-m02   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>   AGE   SELECTOR
</span></span><span class=line><span class=cl>service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   15h   &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES        SELECTOR
</span></span><span class=line><span class=cl>deployment.apps/nginx-deployment   5/5     <span class=m>5</span>            <span class=m>5</span>           91s   nginx        nginx:1.7.9   <span class=nv>app</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                          DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES        SELECTOR
</span></span><span class=line><span class=cl>replicaset.apps/nginx-deployment-5d59d67564   <span class=m>5</span>         <span class=m>5</span>         <span class=m>5</span>       91s   nginx        nginx:1.7.9   <span class=nv>app</span><span class=o>=</span>nginx,pod-template-hash<span class=o>=</span>5d59d67564
</span></span></code></pre></div><br><h4 id=해제 class="relative group">해제 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%95%b4%ec%a0%9c aria-label=Anchor>#</a></span></h4><p>해제 방법은 cordon과 동일하게 <code>uncordon</code> 명령어로 스케줄링 비활성화를 해제한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl uncordon mnlab-m04
</span></span><span class=line><span class=cl>node/mnlab-m04 uncordoned
</span></span></code></pre></div><br><p><code>mnlab-m04</code> 노드에 스케줄링 비활성화(<code>SchedulingDisabled</code>) 상태가 사라졌다. 이후부터는 다시 해당 노드로 pod가 배포될 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get no
</span></span><span class=line><span class=cl>NAME        STATUS                     ROLES                  AGE     VERSION
</span></span><span class=line><span class=cl>mnlab       Ready,SchedulingDisabled   control-plane,master   2d17h   v1.22.3
</span></span><span class=line><span class=cl>mnlab-m02   Ready                      &lt;none&gt;                 48m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m03   Ready                      &lt;none&gt;                 48m     v1.22.3
</span></span><span class=line><span class=cl>mnlab-m04   Ready                      &lt;none&gt;                 47m     v1.22.3
</span></span></code></pre></div></div></section><footer class="pt-8 max-w-prose print:hidden"><script src=https://utteranc.es/client.js repo=seyslee/seyslee.github.io issue-term=pathname label=blog-comment theme=github-dark crossorigin=anonymous async></script></footer></article></main><footer class="py-10 print:hidden"><div class="flex justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Younsung Lee</p></div></div></footer></div></body></html>