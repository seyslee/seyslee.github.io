<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=false><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>prometheus와 grafana 구축 &#183; seyslee</title><meta name=title content="prometheus와 grafana 구축 &#183; seyslee"><meta name=description content="seyslee"><link rel=canonical href=https://seyslee.github.io/blog/k8s/installing-prometheus-and-grafana-with-minikube/><link type=text/css rel=stylesheet href=/css/main.bundle.min.39b7a5b20cc3e1243a974332de8d5e458dd9f15f0f8e06962e8afb4c2b9ce9805c65a0f9359b396ceb5d5f8c16f9ede5d854c208fb561f4fbc5b9a05f4c3cdec.css integrity="sha512-ObelsgzD4SQ6l0My3o1eRY3Z8V8PjgaWLor7TCuc6YBcZaD5NZs5bOtdX4wW+e3l2FTCCPtWH0+8W5oF9MPN7A=="><script type=text/javascript src=/js/appearance.min.12e98742cd283574d030a7fe55f29597df4ee214f7ff7075b4d19a64d046a602753c715295550be7899b661619cec89c679049d36c624681671a8013c1249896.js integrity="sha512-EumHQs0oNXTQMKf+VfKVl99O4hT3/3B1tNGaZNBGpgJ1PHFSlVUL54mbZhYZzsicZ5BJ02xiRoFnGoATwSSYlg=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9ae0a991bb442898e9bc60cf318b4de3ff878325ff3821625a5564b32b2f66aec0e7f7d0e00ca3ac7df59d9f01c18c88b6bdd213184f86ac9ce06d7bdffbadf8.js integrity="sha512-muCpkbtEKJjpvGDPMYtN4/+HgyX/OCFiWlVksysvZq7A5/fQ4AyjrH31nZ8BwYyItr3SExhPhqyc4G173/ut+A==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="prometheus와 grafana 구축"><meta property="og:description" content="minikube 기반의 쿠버네티스 환경에서 prometheus와 grafana를 설치, 구축하는 방법을 설명합니다."><meta property="og:type" content="article"><meta property="og:url" content="https://seyslee.github.io/blog/k8s/installing-prometheus-and-grafana-with-minikube/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-11-25T23:26:15+09:00"><meta property="article:modified_time" content="2021-11-25T23:27:10+09:00"><meta property="og:site_name" content="seyslee"><meta name=twitter:card content="summary"><meta name=twitter:title content="prometheus와 grafana 구축"><meta name=twitter:description content="minikube 기반의 쿠버네티스 환경에서 prometheus와 grafana를 설치, 구축하는 방법을 설명합니다."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blogs","name":"prometheus와 grafana 구축","headline":"prometheus와 grafana 구축","description":"minikube 기반의 쿠버네티스 환경에서 prometheus와 grafana를 설치, 구축하는 방법을 설명합니다.","abstract":"개요 # minikube 기반의 로컬 쿠버네티스 환경에서 prometheus와 grafana를 설치, 구축하는 방법을 설명합니다.","inLanguage":"en","url":"https:\/\/seyslee.github.io\/blog\/k8s\/installing-prometheus-and-grafana-with-minikube\/","author":{"@type":"Person","name":"Younsung Lee"},"copyrightYear":"2021","dateCreated":"2021-11-25T23:26:15\u002b09:00","datePublished":"2021-11-25T23:26:15\u002b09:00","dateModified":"2021-11-25T23:27:10\u002b09:00","keywords":["devops","kubernetes"],"mainEntityOfPage":"true","wordCount":"2202"}]</script><meta name=author content="Younsung Lee"><link href=mailto:ivecloudblack@gmail.com rel=me><link href=https://github.com/seyslee rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="flex justify-between py-6 font-semibold sm:items-center sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>seyslee</a></div><nav><ul class="flex flex-col list-none sm:flex-row"><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/blog/ title=Blogs>Post</a></li><li class="mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>Tag</a></li></ul></nav></header><main id=main-content class="relative grow"><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">prometheus와 grafana 구축</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2021-11-25 23:26:15 +0900 +0900">Nov 25, 2021</time><span class="px-2 text-primary-500">&#183;</span><time datetime="2021-11-25 23:27:10 +0900 +0900">Updated: Nov 25, 2021</time></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 lg:mt-3"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#개요>개요</a></li><li><a href=#환경>환경</a></li><li><a href=#본문>본문</a><ul><li><a href=#1-minikube-kubectl-설치>1. minikube, kubectl 설치</a></li><li><a href=#2-helm-3-설치>2. helm 3 설치</a><ul><li></li></ul></li><li><a href=#3-minikube-구성>3. minikube 구성</a><ul><li></li></ul></li><li><a href=#4-prometheus-설치-및-구성>4. prometheus 설치 및 구성</a><ul><li></li></ul></li><li><a href=#5-grafana-설치-및-구성>5. grafana 설치 및 구성</a><ul><li></li></ul></li></ul></li><li><a href=#결론>결론</a></li><li><a href=#참고자료>참고자료</a></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><h1 id=개요 class="relative group">개요 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b0%9c%ec%9a%94 aria-label=Anchor>#</a></span></h1><p>minikube 기반의 로컬 쿠버네티스 환경에서 prometheus와 grafana를 설치, 구축하는 방법을 설명합니다.</p><br><h1 id=환경 class="relative group">환경 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%99%98%ea%b2%bd aria-label=Anchor>#</a></span></h1><ul><li><strong>Hardware</strong> : MacBook Pro (13", M1, 2020)</li><li><strong>OS</strong> : macOS Monterey 12.0.1</li><li><strong>패키지 관리자</strong> : brew v3.3.5</li><li><strong>Kubernetes 환경</strong><ul><li><strong>Docker Desktop v4.2.0 (70708)</strong> : Kubernetes 기능 활성화됨 (<code>Enable Kubernetes</code>)</li><li><strong>minikube v1.24.0</strong> : brew를 이용하여 설치. 단일 노드 1개 생성.</li><li><strong>kubectl v1.22.4</strong> : brew를 이용하여 설치</li><li><strong>helm v3.7.1</strong> : brew를 이용하여 설치</li><li><strong>prometheus v2.31.1</strong> : helm을 이용하여 설치 및 배포</li><li><strong>grafana v8.2.5</strong> : helm을 이용하여 설치 및 배포</li></ul></li></ul><br><h1 id=본문 class="relative group">본문 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%b3%b8%eb%ac%b8 aria-label=Anchor>#</a></span></h1><h2 id=1-minikube-kubectl-설치 class="relative group">1. minikube, kubectl 설치 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-minikube-kubectl-%ec%84%a4%ec%b9%98 aria-label=Anchor>#</a></span></h2><p>macOS용 채키지 관리자인 brew를 이용해 minikube와 kubectl을 설치합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ brew install minikube
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ brew install kubectl
</span></span></code></pre></div><br><h2 id=2-helm-3-설치 class="relative group">2. helm 3 설치 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-helm-3-%ec%84%a4%ec%b9%98 aria-label=Anchor>#</a></span></h2><p>helm은 쿠버네티스의 패키지 관리자(Kubernetes Package Manager)입니다. helm을 이용하면 prometheus와 grafana를 설치와 동시에 자동 구성할 수 있습니다.</p><br><h4 id=helm-설치 class="relative group">helm 설치 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#helm-%ec%84%a4%ec%b9%98 aria-label=Anchor>#</a></span></h4><p>macOS용 패키지 관리자인 brew를 이용해 helm을 설치합니다. brew를 이용해 설치하는 이유는 패키지 관리가 편리하기 때문입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ brew install helm
</span></span><span class=line><span class=cl>Updating Homebrew...
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Auto-updated Homebrew!
</span></span><span class=line><span class=cl>Updated <span class=m>2</span> taps <span class=o>(</span>homebrew/core and homebrew/cask<span class=o>)</span>.
</span></span><span class=line><span class=cl><span class=o>[</span>...<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Downloading https://ghcr.io/v2/homebrew/core/helm/manifests/3.7.1
</span></span><span class=line><span class=cl><span class=c1>######################################################################## 100.0%</span>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Downloading https://ghcr.io/v2/homebrew/core/helm/blobs/sha256:8587566f16cef
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Downloading from https://pkg-containers.githubusercontent.com/ghcr1/blobs/sh
</span></span><span class=line><span class=cl><span class=c1>######################################################################## 100.0%</span>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Pouring helm--3.7.1.arm64_monterey.bottle.tar.gz
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Caveats
</span></span><span class=line><span class=cl>zsh completions have been installed to:
</span></span><span class=line><span class=cl>  /opt/homebrew/share/zsh/site-functions
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Summary
</span></span><span class=line><span class=cl>🍺  /opt/homebrew/Cellar/helm/3.7.1: <span class=m>60</span> files, 51MB
</span></span></code></pre></div><p>helm 3.7.1이 정상적으로 설치되었습니다. 60개의 파일이 포함되어 있고, helm의 용량은 51MB 입니다.</p><br><h4 id=helm-설치-정보-확인 class="relative group">helm 설치 정보 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#helm-%ec%84%a4%ec%b9%98-%ec%a0%95%eb%b3%b4-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>helm의 안정화된 버전(Stable)인 3.7.1이 설치되었습니다.</p><p>버전정보 아래에는 <code>Kubernetes package manager</code>라는 간단한 설명이 적혀있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ brew info helm
</span></span><span class=line><span class=cl>helm: stable 3.7.1 <span class=o>(</span>bottled<span class=o>)</span>, HEAD
</span></span><span class=line><span class=cl>Kubernetes package manager
</span></span><span class=line><span class=cl>https://helm.sh/
</span></span><span class=line><span class=cl>/opt/homebrew/Cellar/helm/3.7.1 <span class=o>(</span><span class=m>60</span> files, 51MB<span class=o>)</span> *
</span></span><span class=line><span class=cl>  Poured from bottle on 2021-11-25 at 20:48:43
</span></span><span class=line><span class=cl>From: https://githubcom/Homebrew/homebrew-core/blob/HEAD/Formula/helm.rb
</span></span><span class=line><span class=cl>License: Apache-2.0
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Dependencies
</span></span><span class=line><span class=cl>Build: go ✘
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Options
</span></span><span class=line><span class=cl>--HEAD
</span></span><span class=line><span class=cl>	Install HEAD <span class=nv>version</span>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Caveats
</span></span><span class=line><span class=cl>zsh completions have been installed to:
</span></span><span class=line><span class=cl>  /opt/homebrew/share/zsh/site-functions
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Analytics
</span></span><span class=line><span class=cl>install: 35,802 <span class=o>(</span><span class=m>30</span> days<span class=o>)</span>, 121,935 <span class=o>(</span><span class=m>90</span> days<span class=o>)</span>, 487,738 <span class=o>(</span><span class=m>365</span> days<span class=o>)</span>
</span></span><span class=line><span class=cl>install-on-request: 35,054 <span class=o>(</span><span class=m>30</span> days<span class=o>)</span>, 119,382 <span class=o>(</span><span class=m>90</span> days<span class=o>)</span>, 477,316 <span class=o>(</span><span class=m>365</span> days<span class=o>)</span>
</span></span><span class=line><span class=cl>build-error: <span class=m>17</span> <span class=o>(</span><span class=m>30</span> days<span class=o>)</span>
</span></span></code></pre></div><br><h4 id=helm-버전-확인 class="relative group">helm 버전 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#helm-%eb%b2%84%ec%a0%84-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>helm 명령어가 잘 실행되는 지 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm version
</span></span><span class=line><span class=cl>version.BuildInfo<span class=o>{</span>Version:<span class=s2>&#34;v3.7.1&#34;</span>, GitCommit:<span class=s2>&#34;1d11fcb5d3f3bf00dbe6fe31b8412839a96b3dc4&#34;</span>, GitTreeState:<span class=s2>&#34;clean&#34;</span>, GoVersion:<span class=s2>&#34;go1.17.2&#34;</span><span class=o>}</span>
</span></span></code></pre></div><br><h2 id=3-minikube-구성 class="relative group">3. minikube 구성 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-minikube-%ea%b5%ac%ec%84%b1 aria-label=Anchor>#</a></span></h2><p>minikube를 이용해 단일 노드로 구성된 kubernetes 환경을 먼저 만들고, 그 1대의 노드 위에 prometheus와 grafana를 배포해서 서비스할 계획입니다.</p><p>이번 시나리오는 2대 이상의 멀티 노드가 아니라 마스터 노드 1개만으로 구성됩니다.</p><br><h4 id=minikube-시작 class="relative group">minikube 시작 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#minikube-%ec%8b%9c%ec%9e%91 aria-label=Anchor>#</a></span></h4><p>docker 환경을 이용해서 minikube 노드 1개를 생성합니다. 해당 노드에 리소스는 2코어(<code>CPUs=2</code>)에 메모리가 <code>1988MB</code>가 할당되었습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube start -p prom-demo
</span></span><span class=line><span class=cl>😄  <span class=o>[</span>prom-demo<span class=o>]</span> Darwin 12.0.1 <span class=o>(</span>arm64<span class=o>)</span> 의 minikube v1.24.0
</span></span><span class=line><span class=cl>✨  자동적으로 docker 드라이버가 선택되었습니다. 다른 드라이버 목록: virtualbox, ssh
</span></span><span class=line><span class=cl>👍  prom-demo 클러스터의 prom-demo 컨트롤 플레인 노드를 시작하는 중
</span></span><span class=line><span class=cl>🚜  베이스 이미지를 다운받는 중 ...
</span></span><span class=line><span class=cl>🔥  Creating docker container <span class=o>(</span><span class=nv>CPUs</span><span class=o>=</span>2, <span class=nv>Memory</span><span class=o>=</span>1988MB<span class=o>)</span> ...
</span></span><span class=line><span class=cl>🐳  쿠버네티스 v1.22.3 을 Docker 20.10.8 런타임으로 설치하는 중
</span></span><span class=line><span class=cl>    ▪ 인증서 및 키를 생성하는 중 ...
</span></span><span class=line><span class=cl>    ▪ 컨트롤 플레인이 부팅...
</span></span><span class=line><span class=cl>    ▪ RBAC 규칙을 구성하는 중 ...
</span></span><span class=line><span class=cl>🔎  Kubernetes 구성 요소를 확인...
</span></span><span class=line><span class=cl>    ▪ Using image gcr.io/k8s-minikube/storage-provisioner:v5
</span></span><span class=line><span class=cl>🌟  애드온 활성화 : storage-provisioner, default-storageclass
</span></span><span class=line><span class=cl>🏄  끝났습니다! kubectl이 <span class=s2>&#34;prom-demo&#34;</span> 클러스터와 <span class=s2>&#34;default&#34;</span> 네임스페이스를 기본적으로 사용하도록 구성되었습니다.
</span></span></code></pre></div><p><code>-p</code> 는 profile 옵션입니다. minikube에서는 profile을 통해 여러 개의 실습환경을 편하게 관리할 수 있습니다.</p><br><h4 id=profile-목록-확인 class="relative group">profile 목록 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#profile-%eb%aa%a9%eb%a1%9d-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>제 경우는 예전에 이미 생성해놓은 <code>mnlab</code> profile이 존재합니다. 그 아래에 방금 생성한 <code>prom-demo</code> profile이 보입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube profile list
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>-----------<span class=p>|</span>---------<span class=p>|</span>--------------<span class=p>|</span>------<span class=p>|</span>---------<span class=p>|</span>---------<span class=p>|</span>-------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>  Profile  <span class=p>|</span> VM Driver <span class=p>|</span> Runtime <span class=p>|</span>      IP      <span class=p>|</span> Port <span class=p>|</span> Version <span class=p>|</span> Status  <span class=p>|</span> Nodes <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>-----------<span class=p>|</span>---------<span class=p>|</span>--------------<span class=p>|</span>------<span class=p>|</span>---------<span class=p>|</span>---------<span class=p>|</span>-------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> mnlab     <span class=p>|</span> docker    <span class=p>|</span> docker  <span class=p>|</span> 192.168.49.2 <span class=p>|</span> <span class=m>8443</span> <span class=p>|</span> v1.22.3 <span class=p>|</span> Stopped <span class=p>|</span>     <span class=m>4</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> prom-demo <span class=p>|</span> docker    <span class=p>|</span> docker  <span class=p>|</span> 192.168.49.2 <span class=p>|</span> <span class=m>8443</span> <span class=p>|</span> v1.22.3 <span class=p>|</span> Running <span class=p>|</span>     <span class=m>1</span> <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>-----------<span class=p>|</span>---------<span class=p>|</span>--------------<span class=p>|</span>------<span class=p>|</span>---------<span class=p>|</span>---------<span class=p>|</span>-------<span class=p>|</span>
</span></span></code></pre></div><p>prom-demo profile은 현재 1대의 노드로 구성되어 있으며 동작중(<code>Running</code>)입니다.</p><br><h4 id=profile-상태-확인 class="relative group">profile 상태 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#profile-%ec%83%81%ed%83%9c-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube status -p prom-demo
</span></span><span class=line><span class=cl>prom-demo
</span></span><span class=line><span class=cl>type: Control Plane
</span></span><span class=line><span class=cl>host: Running
</span></span><span class=line><span class=cl>kubelet: Running
</span></span><span class=line><span class=cl>apiserver: Running
</span></span><span class=line><span class=cl>kubeconfig: Configured
</span></span></code></pre></div><p><code>prom-demo</code> 라는 이름의 마스터 노드(<code>Control Plane</code>) 1대만 존재하고, 잘 실행되고 있는 상태입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube node list -p prom-demo
</span></span><span class=line><span class=cl>prom-demo	192.168.49.2
</span></span></code></pre></div><br><h2 id=4-prometheus-설치-및-구성 class="relative group">4. prometheus 설치 및 구성 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-prometheus-%ec%84%a4%ec%b9%98-%eb%b0%8f-%ea%b5%ac%ec%84%b1 aria-label=Anchor>#</a></span></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create ns prometheus
</span></span><span class=line><span class=cl>namespace/prometheus created
</span></span></code></pre></div><p><code>prometheus</code>라는 이름의 namespace를 새로 생성합니다. 명령어의 <code>ns</code>는 namespace의 약어입니다.</p><br><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl config set-context --current --namespace prometheus
</span></span><span class=line><span class=cl>Context <span class=s2>&#34;prom-demo&#34;</span> modified.
</span></span></code></pre></div><p>namespace 환경을 새로 생성한 <code>prometheus</code>로 변경해줍니다. 이제 <code>prometheus</code> namespace 위에 prometheus와 grafana를 설치할 것입니다.</p><br><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl config get-contexts
</span></span><span class=line><span class=cl>CURRENT   NAME             CLUSTER          AUTHINFO         NAMESPACE
</span></span><span class=line><span class=cl>          docker-desktop   docker-desktop   docker-desktop
</span></span><span class=line><span class=cl>*         prom-demo        prom-demo        prom-demo        prometheus
</span></span></code></pre></div><p><code>NAMESPACE</code> 값이 <code>prometheus</code>로 변경된 걸 확인할 수 있습니다.</p><br><h4 id=repo-등록 class="relative group">repo 등록 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#repo-%eb%93%b1%eb%a1%9d aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span class=line><span class=cl><span class=s2>&#34;prometheus-community&#34;</span> has been added to your repositories
</span></span></code></pre></div><p><code>prometheus-community</code>라는 이름으로 repo(repository)를 등록합니다.</p><br><h4 id=repo-확인 class="relative group">repo 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#repo-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm repo list
</span></span><span class=line><span class=cl>NAME                	URL
</span></span><span class=line><span class=cl>prometheus-community	https://prometheus-community.github.io/helm-charts
</span></span></code></pre></div><p><code>prometheus-community</code> repo가 새롭게 생성되었습니다.</p><br><h4 id=prometheus-설치 class="relative group">prometheus 설치 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#prometheus-%ec%84%a4%ec%b9%98 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm install prometheus prometheus-community/prometheus
</span></span><span class=line><span class=cl>NAME: prometheus
</span></span><span class=line><span class=cl>LAST DEPLOYED: Thu Nov <span class=m>25</span> 21:30:28 <span class=m>2021</span>
</span></span><span class=line><span class=cl>NAMESPACE: prometheus
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>1</span>
</span></span><span class=line><span class=cl>TEST SUITE: None
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>The Prometheus server can be accessed via port <span class=m>80</span> on the following DNS name from within your cluster:
</span></span><span class=line><span class=cl>prometheus-server.prometheus.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Get the Prometheus server URL by running these commands in the same shell:
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>POD_NAME</span><span class=o>=</span><span class=k>$(</span>kubectl get pods --namespace prometheus -l <span class=s2>&#34;app=prometheus,component=server&#34;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].metadata.name}&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  kubectl --namespace prometheus port-forward <span class=nv>$POD_NAME</span> <span class=m>9090</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The Prometheus alertmanager can be accessed via port <span class=m>80</span> on the following DNS name from within your cluster:
</span></span><span class=line><span class=cl>prometheus-alertmanager.prometheus.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Get the Alertmanager URL by running these commands in the same shell:
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>POD_NAME</span><span class=o>=</span><span class=k>$(</span>kubectl get pods --namespace prometheus -l <span class=s2>&#34;app=prometheus,component=alertmanager&#34;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].metadata.name}&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  kubectl --namespace prometheus port-forward <span class=nv>$POD_NAME</span> <span class=m>9093</span>
</span></span><span class=line><span class=cl><span class=c1>#################################################################################</span>
</span></span><span class=line><span class=cl><span class=c1>######   WARNING: Pod Security Policy has been moved to a global property.  #####</span>
</span></span><span class=line><span class=cl><span class=c1>######            use .Values.podSecurityPolicy.enabled with pod-based      #####</span>
</span></span><span class=line><span class=cl><span class=c1>######            annotations                                               #####</span>
</span></span><span class=line><span class=cl><span class=c1>######            (e.g. .Values.nodeExporter.podSecurityPolicy.annotations) #####</span>
</span></span><span class=line><span class=cl><span class=c1>#################################################################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The Prometheus PushGateway can be accessed via port <span class=m>9091</span> on the following DNS name from within your cluster:
</span></span><span class=line><span class=cl>prometheus-pushgateway.prometheus.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Get the PushGateway URL by running these commands in the same shell:
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>POD_NAME</span><span class=o>=</span><span class=k>$(</span>kubectl get pods --namespace prometheus -l <span class=s2>&#34;app=prometheus,component=pushgateway&#34;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].metadata.name}&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  kubectl --namespace prometheus port-forward <span class=nv>$POD_NAME</span> <span class=m>9091</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>For more information on running Prometheus, visit:
</span></span><span class=line><span class=cl>https://prometheus.io/
</span></span></code></pre></div><p>helm을 이용해 prometheus를 설치합니다. helm으로 prometheus를 설치하면 prometheus는 pod 형태로 쿠버네티스 노드 위에 배포됩니다.</p><br><h4 id=pod-배포-확인 class="relative group">pod 배포 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#pod-%eb%b0%b0%ed%8f%ac-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>prometheus 설치가 완료되면서 prometheus와 관련된 pod 5개가 배포된 걸 확인할 수 있습니다.</p><p>현재 prometheus가 배포된 namespace 위치는 저희가 아까 새로 생성한 <code>prometheus</code>입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get po -n prometheus
</span></span><span class=line><span class=cl>NAME                                             READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>prometheus-alertmanager-74674b7775-gjhdm         2/2     Running   <span class=m>0</span>          136m
</span></span><span class=line><span class=cl>prometheus-kube-state-metrics-58c5cd6ddb-2vjp5   1/1     Running   <span class=m>0</span>          136m
</span></span><span class=line><span class=cl>prometheus-node-exporter-72m9k                   1/1     Running   <span class=m>0</span>          136m
</span></span><span class=line><span class=cl>prometheus-pushgateway-88fd4899d-xqtzr           1/1     Running   <span class=m>0</span>          136m
</span></span><span class=line><span class=cl>prometheus-server-5d455cb759-62f44               2/2     Running   <span class=m>0</span>          136m
</span></span></code></pre></div><br><p><strong>prometheus pod 별 역할 설명</strong></p><p><figure><img class="my-0 rounded-md" src=./0.png alt="Prometheus Architecture"></figure></p><ul><li><code>alertmanager</code> : alertmanager는 prometheus로부터 전달받은 경보(Alert)를 Email, Slack, Pagerduty 등 여러 방법을 이용해 관리자에게 보내는 역할을 합니다.</li><li><code>kube-state-metrics</code> : Kubernetes Cluster 내부의 자원(CPU, 메모리, 디스크 및 각 컨테이너가 사용하고 있는 리소스 현황, 네트워크 I/O, 정상 컨테이너, 비정상 컨테이너 개수 등)에 대한 매트릭을 수집해주는 exporter입니다.</li><li><code>node-exporter</code> : 서버 노드의 자원에 대한 매트릭을 수집해주는 exporter입니다.</li><li><code>pushgateway</code> : 매트릭을 푸시할 수 있는 중간 서비스입니다.</li><li><code>server</code> : Prometheus WEB UI를 띄울 수 있는 서버입니다.</li></ul><br><h4 id=port-forward class="relative group">port-forward <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#port-forward aria-label=Anchor>#</a></span></h4><p>prometheus-server pod의 이름을 얻어서 <code>POD_NAME</code>이라는 변수에 저장하는 절차입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>POD_NAME</span><span class=o>=</span><span class=k>$(</span>kubectl get pods --namespace prometheus -l <span class=s2>&#34;app=prometheus,component=server&#34;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].metadata.name}&#34;</span><span class=k>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$POD_NAME</span>
</span></span><span class=line><span class=cl>prometheus-server-5d455cb759-62f44
</span></span></code></pre></div><br><p>POD_NAME 변수를 저장하는 명령어는 helm을 이용해 prometheus를 설치할 때 <code>NOTES</code> 부분에 이미 적혀있습니다.</p><p><figure><img class="my-0 rounded-md" src=./1.jpg alt="helm으로 prometheus 설치시 출력되는 메뉴얼 화면"></figure></p><br><p>외부에서 9090 포트로 접속이 들어올 경우, prometheus-server(<code>prometheus-server-5d455cb759-62f44</code>) pod의 9090 포트로 연결해주도록 port-forward 설정합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl --namespace prometheus port-forward <span class=nv>$POD_NAME</span> <span class=m>9090</span>
</span></span><span class=line><span class=cl>Forwarding from 127.0.0.1:9090 -&gt; <span class=m>9090</span>
</span></span><span class=line><span class=cl>Forwarding from <span class=o>[</span>::1<span class=o>]</span>:9090 -&gt; <span class=m>9090</span>
</span></span><span class=line><span class=cl>Handling connection <span class=k>for</span> <span class=m>9090</span>
</span></span><span class=line><span class=cl>Handling connection <span class=k>for</span> <span class=m>9090</span>
</span></span></code></pre></div><br><h4 id=접속-테스트 class="relative group">접속 테스트 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%a0%91%ec%86%8d-%ed%85%8c%ec%8a%a4%ed%8a%b8 aria-label=Anchor>#</a></span></h4><p>웹 브라우저를 열고 Prometheus 웹페이지 주소인 http://localhost:9090으로 접속합니다.</p><p><figure><img class="my-0 rounded-md" src=./2.jpg alt="Prometheus 웹페이지 초기화면"></figure></p><p>Prometheus 웹이 잘 실행됩니다. 이제 Prometheus가 수집한 모니터링 데이터를 검색해서 테스트해봅시다.</p><br><h4 id=수집-데이터-확인 class="relative group">수집 데이터 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%88%98%ec%a7%91-%eb%8d%b0%ec%9d%b4%ed%84%b0-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>prometheus가 쿠버네티스 노드로부터 데이터를 잘 가져왔는지 점검하는 단계입니다. 검색창(돋보기 아이콘)에 <code>kube_node_info</code>를 입력하고, Execute 버튼을 누릅니다.</p><p><figure><img class="my-0 rounded-md" src=./3.jpg alt="prometheus 웹에서 키워드로 검색하는 화면"></figure></p><p>1대 생성된 노드의 전체 정보가 나옵니다.</p><p><strong>노드 관련 정보</strong></p><ul><li><code>container_runtime_version</code> : docker://20.10.8</li><li><code>internal_ip</code> : 192.168.49.2</li><li><code>os_image</code> : Ubuntu 20.04.2 LTS</li><li><code>node</code> : prom-demo</li></ul><br><p>이제 kubectl 명령어로 node 정보를 출력해서 실제로 prometheus에서 수집된 정보와 비교해봅니다. 명령어의 <code>-o wide</code> 옵션은 결과를 더 자세히 출력합니다. <code>no</code>는 node의 약자입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get no -o wide
</span></span><span class=line><span class=cl>NAME        STATUS   ROLES                  AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
</span></span><span class=line><span class=cl>prom-demo   Ready    control-plane,master   50m   v1.22.3   192.168.49.2   &lt;none&gt;        Ubuntu 20.04.2 LTS   5.10.47-linuxkit   docker://20.10.8
</span></span></code></pre></div><p>prometheus 웹의 결과와 명령어 결과를 비교해보니 틀린 내용은 없습니다. prometheus가 쿠버네티스 노드에게서 데이터를 정상적으로 수집해왔습니다.</p><br><h2 id=5-grafana-설치-및-구성 class="relative group">5. grafana 설치 및 구성 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-grafana-%ec%84%a4%ec%b9%98-%eb%b0%8f-%ea%b5%ac%ec%84%b1 aria-label=Anchor>#</a></span></h2><p>grafana는 prometheus가 보내주는 시계열 매트릭 데이터를 시각화하는데 가장 최적화된 오픈소스 대시보드 툴입니다.</p><br><h4 id=repo-등록-1 class="relative group">repo 등록 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#repo-%eb%93%b1%eb%a1%9d-1 aria-label=Anchor>#</a></span></h4><p>helm을 통해 grafana를 다운로드 받기 위해 먼저 repo를 등록합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span class=line><span class=cl><span class=s2>&#34;grafana&#34;</span> has been added to your repositories
</span></span></code></pre></div><br><h4 id=repo-확인-1 class="relative group">repo 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#repo-%ed%99%95%ec%9d%b8-1 aria-label=Anchor>#</a></span></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm repo list
</span></span><span class=line><span class=cl>NAME                	URL
</span></span><span class=line><span class=cl>prometheus-community	https://prometheus-community.github.io/helm-charts
</span></span><span class=line><span class=cl>grafana             	https://grafana.github.io/helm-charts
</span></span></code></pre></div><p><code>grafana</code> repo가 새롭게 등록되었습니다.</p><br><h4 id=설치 class="relative group">설치 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%84%a4%ec%b9%98 aria-label=Anchor>#</a></span></h4><p>helm을 이용해 grafana를 설치합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm install grafana grafana/grafana
</span></span><span class=line><span class=cl>W1125 22:23:14.691555   <span class=m>19170</span> warnings.go:70<span class=o>]</span> policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
</span></span><span class=line><span class=cl>W1125 22:23:14.693706   <span class=m>19170</span> warnings.go:70<span class=o>]</span> policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
</span></span><span class=line><span class=cl>W1125 22:23:14.773504   <span class=m>19170</span> warnings.go:70<span class=o>]</span> policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
</span></span><span class=line><span class=cl>W1125 22:23:14.773573   <span class=m>19170</span> warnings.go:70<span class=o>]</span> policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+
</span></span><span class=line><span class=cl>NAME: grafana
</span></span><span class=line><span class=cl>LAST DEPLOYED: Thu Nov <span class=m>25</span> 22:23:14 <span class=m>2021</span>
</span></span><span class=line><span class=cl>NAMESPACE: prometheus
</span></span><span class=line><span class=cl>STATUS: deployed
</span></span><span class=line><span class=cl>REVISION: <span class=m>1</span>
</span></span><span class=line><span class=cl>NOTES:
</span></span><span class=line><span class=cl>1. Get your <span class=s1>&#39;admin&#39;</span> user password by running:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   kubectl get secret --namespace prometheus grafana -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.admin-password}&#34;</span> <span class=p>|</span> base64 --decode <span class=p>;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2. The Grafana server can be accessed via port <span class=m>80</span> on the following DNS name from within your cluster:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   grafana.prometheus.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Get the Grafana URL to visit by running these commands in the same shell:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=nb>export</span> <span class=nv>POD_NAME</span><span class=o>=</span><span class=k>$(</span>kubectl get pods --namespace prometheus -l <span class=s2>&#34;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana&#34;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].metadata.name}&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>     kubectl --namespace prometheus port-forward <span class=nv>$POD_NAME</span> <span class=m>3000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3. Login with the password from step <span class=m>1</span> and the username: admin
</span></span><span class=line><span class=cl><span class=c1>#################################################################################</span>
</span></span><span class=line><span class=cl><span class=c1>######   WARNING: Persistence is disabled!!! You will lose your data when   #####</span>
</span></span><span class=line><span class=cl><span class=c1>######            the Grafana pod is terminated.                            #####</span>
</span></span><span class=line><span class=cl><span class=c1>#################################################################################</span>
</span></span></code></pre></div><p>helm을 통해 grafana를 설치하면 prometheus와 동일하게 쿠버네티스 노드 위에 pod 형태로 배포됩니다.</p><p><code>NOTES:</code> 부분에는 grafana 설정 가이드가 나와 있습니다. 미리 숙지하면 편합니다.</p><br><h4 id=grafana-배포상태-확인 class="relative group">grafana 배포상태 확인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#grafana-%eb%b0%b0%ed%8f%ac%ec%83%81%ed%83%9c-%ed%99%95%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>helm을 통해 grafana를 설치하면 node에 pod, service, deployment, replicaset이 알아서 배포됩니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get all -l app.kubernetes.io/instance<span class=o>=</span>grafana
</span></span><span class=line><span class=cl>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>pod/grafana-59f986bdc-mbrcg   1/1     Running   <span class=m>0</span>          99m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>   AGE
</span></span><span class=line><span class=cl>service/grafana   ClusterIP   10.102.81.160   &lt;none&gt;        80/TCP    99m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>deployment.apps/grafana   1/1     <span class=m>1</span>            <span class=m>1</span>           99m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                DESIRED   CURRENT   READY   AGE
</span></span><span class=line><span class=cl>replicaset.apps/grafana-59f986bdc   <span class=m>1</span>         <span class=m>1</span>         <span class=m>1</span>       99m
</span></span></code></pre></div><p><code>-l</code> 옵션에 grafana 라벨이 붙은 객체들만 보이도록 제한을 걸면 헷갈리지 않고 grafana 관련 리소스, 오브젝트 목록만 확인할 수 있습니다.</p><br><p>helm에서도 배포상태를 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ helm list
</span></span><span class=line><span class=cl>NAME      	NAMESPACE 	REVISION	UPDATED                             	STATUS  	CHART             	APP VERSION
</span></span><span class=line><span class=cl>grafana   	prometheus	<span class=m>1</span>       	2021-11-25 22:23:14.520143 +0900 KST	deployed	grafana-6.17.7    	8.2.5
</span></span><span class=line><span class=cl>prometheus	prometheus	<span class=m>1</span>       	2021-11-25 21:30:28.306396 +0900 KST	deployed	prometheus-14.12.0	2.31.1
</span></span></code></pre></div><p>grafana v8.2.5는 정상적으로 <code>prometheus</code> 네임스페이스에 배포된 상태(<code>deployed</code>)로 확인됩니다.</p><br><h4 id=admin-계정의-패스워드-찾기 class="relative group">admin 계정의 패스워드 찾기 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#admin-%ea%b3%84%ec%a0%95%ec%9d%98-%ed%8c%a8%ec%8a%a4%ec%9b%8c%eb%93%9c-%ec%b0%be%ea%b8%b0 aria-label=Anchor>#</a></span></h4><p>자동 생성된 grafana 웹페이지의 admin 계정의 패스워드를 찾는 절차입니다.</p><p>grafana 설치시 참고사항(<code>NOTES:</code>)에 적힌 명령어 1번부터 차례대로 실행합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get secret --namespace prometheus grafana -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.admin-password}&#34;</span> <span class=p>|</span> base64 --decode <span class=p>;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>kJYxA6F19BN3TAWcHwsOpqcCOGMJ9sXM1cxOiWxK
</span></span></code></pre></div><p>admin 계정의 암호가 출력됩니다. 이 암호는 잠시후 grafana 웹페이지에 admin 계정으로 로그인할 때 사용되므로 잘 기록해둡니다.</p><br><h4 id=port-forward-1 class="relative group">port-forward <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#port-forward-1 aria-label=Anchor>#</a></span></h4><p>외부에서 3000번 포트로 접속이 들어올 경우 grafana pod로 연결해주도록 port-forward 설정을 해줍니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>POD_NAME</span><span class=o>=</span><span class=k>$(</span>kubectl get pods --namespace prometheus -l <span class=s2>&#34;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=grafana&#34;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].metadata.name}&#34;</span><span class=k>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$POD_NAME</span>
</span></span><span class=line><span class=cl>grafana-59f986bdc-mbrcg
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl --namespace prometheus port-forward <span class=nv>$POD_NAME</span> <span class=m>3000</span>
</span></span><span class=line><span class=cl>Forwarding from 127.0.0.1:3000 -&gt; <span class=m>3000</span>
</span></span><span class=line><span class=cl>Forwarding from <span class=o>[</span>::1<span class=o>]</span>:3000 -&gt; <span class=m>3000</span>
</span></span></code></pre></div><br><h4 id=로그인 class="relative group">로그인 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%a1%9c%ea%b7%b8%ec%9d%b8 aria-label=Anchor>#</a></span></h4><p>http://localhost:3000 으로 접속하면 Grafana 로그인 화면이 나옵니다.</p><p><figure><img class="my-0 rounded-md" src=./4.png alt="Grafana 로그인 화면"></figure></p><p>아까 찾은 admin 계정의 패스워드를 입력한 후 로그인합니다.</p><br><p>Grafana 초기화면입니다.</p><p><figure><img class="my-0 rounded-md" src=./5.png alt="로그인 후 Grafana 초기 화면"></figure></p><br><h4 id=데이터-소스-연결 class="relative group">데이터 소스 연결 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%8d%b0%ec%9d%b4%ed%84%b0-%ec%86%8c%ec%8a%a4-%ec%97%b0%ea%b2%b0 aria-label=Anchor>#</a></span></h4><p>Prometheus는 데이터 수집, Grafana는 데이터 시각화를 담당합니다. Grafana에서 Data source라는 용어는 prometheus, influxDB와 같은 시계열 메트릭 데이터를 담고 있는 대상 데이터베이스라고 생각하면 됩니다. Grafana는 반드시 Data source와 네트워크 연결이 되어야 데이터 시각화를 할 수 있습니다.</p><p>이제 Grafana에 데이터 소스를 등록하는 단계입니다.</p><br><p>Configuration → Data sources → Add data source 클릭</p><p><figure><img class="my-0 rounded-md" src=./6.png alt="Add data source 화면"></figure></p><br><p>Prometheus → Select 버튼 클릭</p><p><figure><img class="my-0 rounded-md" src=./7.png alt="Data Source 설정화면 1"></figure></p><br><p>데이터 소스를 설정하는 화면입니다.</p><p><figure><img class="my-0 rounded-md" src=./8.png alt="Data Source 설정화면 2"></figure></p><br><h4 id=url-확인방법 class="relative group">URL 확인방법 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#url-%ed%99%95%ec%9d%b8%eb%b0%a9%eb%b2%95 aria-label=Anchor>#</a></span></h4><p>data source를 등록하기 위해 먼저 prometheus-server의 IP, Port 정보를 알아야 합니다.</p><p>prometheus-server의 Endpoint 정보를 확인합니다. 명령어에서 <code>ep</code>는 endpoint의 약자입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get ep prometheus-server
</span></span><span class=line><span class=cl>NAME                ENDPOINTS         AGE
</span></span><span class=line><span class=cl>prometheus-server   172.17.0.6:9090   12h
</span></span></code></pre></div><p>제 기준에서 <code>prometheus-server</code>의 Endpoint IP는 <code>172.17.0.6</code>, 포트는 <code>9090</code> 입니다. Endpoint IP는 언제든 바뀔수 있기 때문에 실무 환경에서는 절대 이렇게 사용하지 않습니다.</p><p><strong>주의사항</strong> : <code>prometheus-server</code>의 Endpoint IP 주소는 각자 다를 수 있기 때문에 제 주소를 그대로 적어서 넣으면 통신불가로 인한 <code>Bad gateway</code> 오류가 발생합니다. 반드시 <code>kubectl get ep prometheus-server</code> 명령어로 직접 확인후 입력 바랍니다.</p><br><p><strong>입력결과</strong></p><p><figure><img class="my-0 rounded-md" src=./10.jpg alt="데이터 소스 설정결과 화면"></figure></p><ul><li><strong>URL</strong> : 위에서 확인한 <code>prometheus-server</code>의 endpoint 정보를 입력해줍니다.</li><li><strong>Access</strong> : Server (default)<ul><li>Browser 방식은 곧 사용 중단(Deprecated)될 예정이기 때문에 가급적이면 사용하지 않는 걸 권고합니다.</li></ul></li></ul><br><p><figure><img class="my-0 rounded-md" src=./11.jpg alt="Save &amp;amp; test 버튼 위치"></figure></p><p>URL 값을 입력했다면 맨 아래에 위치한 Save & test 버튼을 눌러줍니다.</p><br><p>Grafana가 Prometheus와 정상 연결되었을 경우 <code>Data source is working</code> 메세지가 출력됩니다.</p><p><figure><img class="my-0 rounded-md" src=./12.jpg alt="Data source is working 메세지가 출력된 화면"></figure></p><p>이제 Prometheus로 수집한 데이터를 시각화할 대시보드만 생성해주면 작업은 끝납니다.</p><br><h4 id=grafana-dashboard-import class="relative group">grafana dashboard import <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#grafana-dashboard-import aria-label=Anchor>#</a></span></h4><p><a href=https://grafana.com/grafana/dashboards/>Grafana Labs</a> 공식 사이트에서 제공하는 대시보드 레이아웃들 중에서 마음에 드는걸 골라서 Import로 불러올 수 있습니다.</p><br><p>Grafana Labs 사이트에 접속해서 메인화면에 보이는 Node Exporter Full를 클릭합니다.</p><p><figure><img class="my-0 rounded-md" src=./13.png alt="Grafana Labs 메인화면"></figure></p><br><p>Node Exporter Full 대시보드는 Node Exporter가 수집한 노드 관련 정보를 디테일하게 표시해주는 레이아웃의 대시보드입니다.</p><p><figure><img class="my-0 rounded-md" src=./14.png alt="Node Exporter Full 대시보드"></figure></p><p>Node Exporter Full의 Dashboard ID 값인 1860을 기억해둡니다. 잠시후 Node Exporter Full 대시보드를 불러오는 단계(Import)에서 해당 ID 값 입력이 필요합니다.</p><br><p>&lsquo;+&rsquo; 아이콘(Create) → Import 클릭</p><p><figure><img class="my-0 rounded-md" src=./15.jpg alt="Import 화면"></figure></p><br><p>Dashboard ID인 <code>1860</code> 입력 → 우측 Load 버튼 클릭</p><p><figure><img class="my-0 rounded-md" src=./16.jpg alt></figure></p><br><p>Prometheus 선택 → Import</p><p><figure><img class="my-0 rounded-md" src=./17.png alt></figure></p><br><p><figure><img class="my-0 rounded-md" src=./18.png alt="Node Exporter Full 대시보드 생성화면"></figure></p><p>Grafana 공식 사이트에 업로드된 Node Exporter Full 대시보드를 받아 환경에 생성한 결과입니다.</p><p>CPU Basic, Memory Basic, Network Traffic Basic 등의 노드 데이터 수집도 정상적으로 진행되고 있습니다.</p><br><h1 id=결론 class="relative group">결론 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b2%b0%eb%a1%a0 aria-label=Anchor>#</a></span></h1><p>Kubernetes 환경에서 Prometheus + Grafana는 이제 선택을 넘어서 엔지니어에게 필수로 요구되는 모니터링 기술 스택입니다.</p><p>Prometheus는 모니터링 데이터를 수집하는 역할, Grafana는 Prometheus가 수집한 데이터를 관리자가 보기 좋게 시각화하는 역할을 담당합니다. 컨테이너 인프라 환경에서는 많은 종류의 소규모 기능이 각각 작은 단위로 나뉘어진 마이크로서비스 아키텍쳐로 개발 및 배포되기 때문에 반드시 중앙 모니터링이 필요합니다. 이때 효율적으로 모니터링할 수 있는 테크 스택 중 하나가 Prometheus와 Grafana의 조합입니다. Prometheus와 Grafana는 컨테이너 형태로 패키징되어 동작하며 최소한의 자원으로 쿠버네티스 클러스터의 상태를 시각적으로 표현합니다.</p><p>기업의 규모 가릴 것 없이 모니터링 목적으로 사용하는 테크 스택이기 때문에 심도 있게 배워두면 취업 뿐만 아니라 커리어에도 큰 도움이 될 거라고 생각합니다.</p><br><h1 id=참고자료 class="relative group">참고자료 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%b0%b8%ea%b3%a0%ec%9e%90%eb%a3%8c aria-label=Anchor>#</a></span></h1><p><a href=https://prometheus.io/docs/introduction/overview/>https://prometheus.io/docs/introduction/overview/</a> : Prometheus Architecture</p><p><a href=https://stackoverflow.com/questions/48338122/grafana-http-error-bad-gateway-and-templating-init-failed-errors>https://stackoverflow.com/questions/48338122/grafana-http-error-bad-gateway-and-templating-init-failed-errors</a> : Bad gateway 네트워크 이슈 발생시 참고</p></div></section><footer class="pt-8 max-w-prose print:hidden"><script src=https://utteranc.es/client.js repo=seyslee/seyslee.github.io issue-term=pathname label=blog-comment theme=github-dark crossorigin=anonymous async></script></footer></article></main><footer class="py-10 print:hidden"><div class="flex justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Younsung Lee</p></div></div></footer></body></html>