<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>ArgoCD on minikube &#183; seyslee</title><meta name=title content="ArgoCD on minikube &#183; seyslee"><meta name=description content="seyslee"><link rel=canonical href=https://seyslee.github.io/blog/k8s/argocd-on-minikube/><link type=text/css rel=stylesheet href=/css/main.bundle.min.fff8ff4cdbe2bf80930c53b6e47a6d9826b914a8623246481ff09ff52ea48fcfb403d9ba1dc7bbc800a7ecb15298c468838a661dd8ebb3e9f46fdca239b38a30.css integrity="sha512-//j/TNviv4CTDFO25HptmCa5FKhiMkZIH/Cf9S6kj8+0A9m6Hce7yACn7LFSmMRog4pmHdjrs+n0b9yiObOKMA=="><script type=text/javascript src=/js/appearance.min.badab316c9287a5a42a843e4eb45da65bb3d194a5a0f5fa4a3e516160e67df0b8c65f4f19a8e146436e29d583699e6cb41d6bbe99e05e1dbaa877763bad9f8e2.js integrity="sha512-utqzFskoelpCqEPk60XaZbs9GUpaD1+ko+UWFg5n3wuMZfTxmo4UZDbinVg2mebLQda76Z4F4duqh3djutn44g=="></script>
<script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.9947db70e5b36e741e53f8531bd734741b3fc7a688f7b5d749fc5433c48efc252f47bdf44e471570a550fc051b87712799014040e6349b38d64448b94e84e45a.js integrity="sha512-mUfbcOWzbnQeU/hTG9c0dBs/x6aI97XXSfxUM8SO/CUvR730TkcVcKVQ/AUbh3EnmQFAQOY0mzjWREi5ToTkWg==" data-copy=Copy data-copied=Copied></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:title" content="ArgoCD on minikube"><meta property="og:description" content="minikube 환경에서 ArgoCD 설치하고 운영해보는 가이드 문서."><meta property="og:type" content="article"><meta property="og:url" content="https://seyslee.github.io/blog/k8s/argocd-on-minikube/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-07-06T23:56:40+09:00"><meta property="article:modified_time" content="2022-07-06T23:57:05+09:00"><meta property="og:site_name" content="seyslee"><meta name=twitter:card content="summary"><meta name=twitter:title content="ArgoCD on minikube"><meta name=twitter:description content="minikube 환경에서 ArgoCD 설치하고 운영해보는 가이드 문서."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Blogs","name":"ArgoCD on minikube","headline":"ArgoCD on minikube","description":"minikube 환경에서 ArgoCD 설치하고 운영해보는 가이드 문서.","abstract":"개요 # ArgoCD는 쿠버네티스 클러스터와 함께 사용하는 대표적인 GitOps 구현체입니다.","inLanguage":"en","url":"https:\/\/seyslee.github.io\/blog\/k8s\/argocd-on-minikube\/","author":{"@type":"Person","name":"Younsung Lee"},"copyrightYear":"2022","dateCreated":"2022-07-06T23:56:40\u002b09:00","datePublished":"2022-07-06T23:56:40\u002b09:00","dateModified":"2022-07-06T23:57:05\u002b09:00","keywords":["devops","kubernetes","minikube"],"mainEntityOfPage":"true","wordCount":"1175"}]</script><meta name=author content="Younsung Lee"><link href=mailto:ivecloudblack@gmail.com rel=me><link href=https://github.com/seyslee rel=me></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 bg-neutral text-neutral-900 sm:px-14 md:px-24 lg:px-32 dark:bg-neutral-800 dark:text-neutral max-w-7xl"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 dark:bg-neutral-600 focus:translate-y-0" href=#main-content><span class="font-bold ltr:pr-2 rtl:pl-2 text-primary-600 dark:text-primary-400">&darr;</span>Skip to main content</a></div><header class="py-6 font-semibold sm:py-10 text-neutral-900 dark:text-neutral print:hidden"><nav class="flex justify-between"><div><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" rel=me href=/>seyslee</a></div><ul class="flex flex-col list-none ltr:text-right rtl:text-left sm:flex-row"><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/blog/ title=Blogs>post</a></li><li class="mb-1 sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href=/tags/ title=Tags>tag</a></li></ul></nav></header><div class="relative flex flex-col grow"><main id=main-content class=grow><article><header class=max-w-prose><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">ArgoCD on minikube</h1><div class="mt-8 mb-12 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2022-07-06 23:56:40 +0900 +0900">Jul 6, 2022</time></div></div></header><section class="flex flex-col max-w-full mt-0 prose lg:flex-row dark:prose-invert"><div class="order-first px-0 lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8 lg:order-last"><div class="ltr:pl-5 rtl:pr-5 toc lg:sticky lg:top-10 print:hidden"><details open class="mt-0 overflow-hidden rounded-lg rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5"><summary class="block py-1 text-lg font-semibold cursor-pointer rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 text-neutral-800 dark:text-neutral-100 lg:hidden bg-neutral-100 dark:bg-neutral-700">Table of Contents</summary><div class="py-2 border-dotted ltr:border-l rtl:border-r rtl:pr-5 ltr:pl-5 ltr:-ml-5 rtl:-mr-5 border-neutral-300 dark:border-neutral-600"><nav id=TableOfContents><ul><li><ul><li><a href=#개요>개요</a></li><li><a href=#전제조건>전제조건</a></li><li><a href=#환경>환경</a></li><li><a href=#실습하기>실습하기</a><ul><li><a href=#1-minikube-클러스터-생성>1. minikube 클러스터 생성</a></li><li><a href=#2-argocd-설치>2. ArgoCD 설치</a></li><li><a href=#3-argocd-웹-접속>3. ArgoCD 웹 접속</a></li><li><a href=#4-application-배포하기>4. Application 배포하기</a></li><li><a href=#5-selfheal-기능-활성화>5. selfHeal 기능 활성화</a></li></ul></li><li><a href=#정리하기>정리하기</a></li><li><a href=#마치며>마치며</a></li></ul></li></ul></nav></div></details></div></div><div class="min-w-0 min-h-0 max-w-prose"><h2 id=개요 class="relative group">개요 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ea%b0%9c%ec%9a%94 aria-label=Anchor>#</a></span></h2><p>ArgoCD는 쿠버네티스 클러스터와 함께 사용하는 대표적인 GitOps 구현체입니다.</p><p>이 글은 minikube 클러스터 환경에 ArgoCD를 설치하고 데모 어플리케이션을 배포해보는 일련의 과정들을 설명하고 있습니다.</p><p> </p><h2 id=전제조건 class="relative group">전제조건 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%a0%84%ec%a0%9c%ec%a1%b0%ea%b1%b4 aria-label=Anchor>#</a></span></h2><ul><li>minikube가 설치되어 있어야 합니다.</li><li>docker desktop이 설치되어 있어야 합니다.</li></ul><p>macOS의 경우 패키지 관리자인 homebrew를 이용해 minikube와 docker dekstop 모두 쉽게 설치할 수 있습니다.<br>물론 이 글에서 관련 패키지의 설치 과정까지 설명하지는 않습니다.</p><p> </p><h2 id=환경 class="relative group">환경 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ed%99%98%ea%b2%bd aria-label=Anchor>#</a></span></h2><ul><li><strong>OS</strong> : macOS Monterey 12.4 (M1 Pro)</li><li><strong>Shell</strong> : zsh + oh-my-zsh</li><li><strong>minikube</strong> v1.26.0 (brew로 설치함)</li><li><strong>docker desktop</strong> v20.10.16 (brew로 설치함)</li></ul><p>저희가 구성할 ArgoCD 아키텍쳐는 다음과 같습니다.</p><p><figure><img class="my-0 rounded-md" src=./1.png alt=Architecture></figure></p><p> </p><h2 id=실습하기 class="relative group">실습하기 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%8b%a4%ec%8a%b5%ed%95%98%ea%b8%b0 aria-label=Anchor>#</a></span></h2><h3 id=1-minikube-클러스터-생성 class="relative group">1. minikube 클러스터 생성 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#1-minikube-%ed%81%b4%eb%9f%ac%ec%8a%a4%ed%84%b0-%ec%83%9d%ec%84%b1 aria-label=Anchor>#</a></span></h3><p><code>minikube</code> 명령어가 정상 동작하는지 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube version
</span></span><span class=line><span class=cl>minikube version: v1.26.0
</span></span><span class=line><span class=cl>commit: f4b412861bb746be73053c9f6d2895f12cf78565
</span></span></code></pre></div><p> </p><p>노드 3대로 구성된 minikube 클러스터를 생성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube start <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --driver<span class=o>=</span><span class=s1>&#39;docker&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --nodes<span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --addons<span class=o>=</span><span class=s1>&#39;ingress&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubernetes-version<span class=o>=</span><span class=s1>&#39;stable&#39;</span>
</span></span></code></pre></div><p>minikube 클러스터를 생성할 때 <code>--addons</code> 옵션을 사용해서 ingress addons를 활성화해주는 게 중요 포인트입니다.</p><p> </p><p><strong>Addon 확인</strong><br><code>ingress</code> 애드온이 활성화되어 있는지 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube addons list
</span></span></code></pre></div><p>현재 <code>ingress</code> 애드온이 <code>enabled ✅</code>로 활성화된 상태입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=p>|</span>-----------------------------<span class=p>|</span>----------<span class=p>|</span>--------------<span class=p>|</span>--------------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>         ADDON NAME          <span class=p>|</span> PROFILE  <span class=p>|</span>    STATUS    <span class=p>|</span>           MAINTAINER           <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>-----------------------------<span class=p>|</span>----------<span class=p>|</span>--------------<span class=p>|</span>--------------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ...                         <span class=p>|</span> ...      <span class=p>|</span> ...          <span class=p>|</span> ...                            <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ingress                     <span class=p>|</span> minikube <span class=p>|</span> enabled ✅   <span class=p>|</span> 3rd party <span class=o>(</span>unknown<span class=o>)</span>            <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ...                         <span class=p>|</span> ...      <span class=p>|</span> ...          <span class=p>|</span> ...                            <span class=p>|</span>
</span></span></code></pre></div><p> </p><p><strong>Node 확인</strong><br>minikube 클러스터를 구성하는 노드 정보를 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get node
</span></span><span class=line><span class=cl>NAME           STATUS   ROLES           AGE   VERSION
</span></span><span class=line><span class=cl>minikube       Ready    control-plane   84m   v1.24.1
</span></span><span class=line><span class=cl>minikube-m02   Ready    &lt;none&gt;          82m   v1.24.1
</span></span><span class=line><span class=cl>minikube-m03   Ready    &lt;none&gt;          81m   v1.24.1
</span></span></code></pre></div><p>컨트롤 플레인 1대와 워커노드 2대로 구성되어 있습니다.<br>모든 노드는 쿠버네티스 <code>v1.24.1</code>을 사용하고 있습니다.</p><p> </p><h3 id=2-argocd-설치 class="relative group">2. ArgoCD 설치 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#2-argocd-%ec%84%a4%ec%b9%98 aria-label=Anchor>#</a></span></h3><p><strong>네임스페이스 생성</strong><br><code>argocd</code> 네임스페이스를 생성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl create namespace argocd
</span></span></code></pre></div><p> </p><h4 id=argocd-배포 class="relative group">ArgoCD 배포 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#argocd-%eb%b0%b0%ed%8f%ac aria-label=Anchor>#</a></span></h4><p>이후 ArgoCD 설치 매니페스트를 다운로드 받는 동시에 <code>apply</code>로 배포합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n argocd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
</span></span></code></pre></div><p>stable 버전의 ArgoCD를 배포할 네임스페이스는 저희가 방금 만든 <code>argocd</code> 네임스페이스입니다.</p><p> </p><h4 id=배포-과정-모니터링 class="relative group">배포 과정 모니터링 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%b0%b0%ed%8f%ac-%ea%b3%bc%ec%a0%95-%eb%aa%a8%eb%8b%88%ed%84%b0%eb%a7%81 aria-label=Anchor>#</a></span></h4><p>ArgoCD 컴포넌트 전체가 설치되기 까지 최소 2분 이상 소요됩니다.<br>ArgoCD가 설치되는 동안 <code>watch</code> 명령어를 사용해 ArgoCD 관련 파드의 생성 과정을 모니터링합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ watch -d -n1 <span class=s2>&#34;kubectl get all -n argocd&#34;</span>
</span></span></code></pre></div><p><strong>watch 명령어 설명</strong><br><code>-d</code> : 값이 변화하면 터미널에 음영처리해서 표시해주는 옵션입니다.<br><code>-n1</code> : 모니터링을 1초 간격으로 진행한다는 의미입니다.</p><p> </p><p>argocd-server 서비스의 기본 타입은 <code>ClusterIP</code> 입니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get service argocd-server -n argocd
</span></span><span class=line><span class=cl>NAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>          AGE
</span></span><span class=line><span class=cl>argocd-server   ClusterIP   10.102.205.163   &lt;none&gt;        80/TCP,443/TCP   2m59s
</span></span></code></pre></div><p> </p><h4 id=서비스-설정 class="relative group">서비스 설정 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%84%9c%eb%b9%84%ec%8a%a4-%ec%84%a4%ec%a0%95 aria-label=Anchor>#</a></span></h4><p>ArgoCD 설치가 완료되었으면 이제 ArgoCD 서비스 타입을 기본값인 <code>ClusterIP</code>에서 <code>LoadBalancer</code>로 변경합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl patch svc argocd-server <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n argocd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;LoadBalancer&#34;}}&#39;</span>
</span></span><span class=line><span class=cl>service/argocd-server patched
</span></span></code></pre></div><p> </p><p>서비스 타입이 <code>ClusterIP</code>에서 <code>LoadBalancer</code>로 변경된 걸 확인할 수 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get service argocd-server -n argocd
</span></span><span class=line><span class=cl>NAME            TYPE           CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>                      AGE
</span></span><span class=line><span class=cl>argocd-server   LoadBalancer   10.102.205.163   &lt;pending&gt;     80:31129/TCP,443:32744/TCP   3m46s
</span></span></code></pre></div><p> </p><h3 id=3-argocd-웹-접속 class="relative group">3. ArgoCD 웹 접속 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#3-argocd-%ec%9b%b9-%ec%a0%91%ec%86%8d aria-label=Anchor>#</a></span></h3><p>minikube에서 <code>arogcd</code> 서비스가 외부에 노출된 상태인지 확인합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube service list <span class=p>|</span> grep argocd
</span></span></code></pre></div><p> </p><p>minikube 클러스터 안에 서비스로 연결합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube service argocd-server -n argocd
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>---------------<span class=p>|</span>-------------<span class=p>|</span>---------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> NAMESPACE <span class=p>|</span>     NAME      <span class=p>|</span> TARGET PORT <span class=p>|</span>            URL            <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>---------------<span class=p>|</span>-------------<span class=p>|</span>---------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> argocd    <span class=p>|</span> argocd-server <span class=p>|</span> http/80     <span class=p>|</span> http://192.168.49.2:31129 <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>           <span class=p>|</span>               <span class=p>|</span> https/443   <span class=p>|</span> http://192.168.49.2:32744 <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>---------------<span class=p>|</span>-------------<span class=p>|</span>---------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl>🏃  argocd-server 서비스의 터널을 시작하는 중
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>---------------<span class=p>|</span>-------------<span class=p>|</span>------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> NAMESPACE <span class=p>|</span>     NAME      <span class=p>|</span> TARGET PORT <span class=p>|</span>          URL           <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>---------------<span class=p>|</span>-------------<span class=p>|</span>------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span> argocd    <span class=p>|</span> argocd-server <span class=p>|</span>             <span class=p>|</span> http://127.0.0.1:63319 <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>           <span class=p>|</span>               <span class=p>|</span>             <span class=p>|</span> http://127.0.0.1:63320 <span class=p>|</span>
</span></span><span class=line><span class=cl><span class=p>|</span>-----------<span class=p>|</span>---------------<span class=p>|</span>-------------<span class=p>|</span>------------------------<span class=p>|</span>
</span></span><span class=line><span class=cl><span class=o>[</span>argocd argocd-server  http://127.0.0.1:63319
</span></span><span class=line><span class=cl>http://127.0.0.1:63320<span class=o>]</span>
</span></span><span class=line><span class=cl>❗  Because you are using a Docker driver on darwin, the terminal needs to be open to run it.
</span></span></code></pre></div><p>위 명령어에서 <code>http://127.0.0.1:63320</code> 주소를 복사합니다.<br>참고로 127.0.0.1 뒤에 붙는 포트는 각자 환경마다 다릅니다.</p><p>웹 브라우저를 열고 해당 주소로 접속하면 ArgoCD 로그인 페이지를 만나게 됩니다.</p><p><figure><img class="my-0 rounded-md" src=./2.png alt="ArgoCD 로그인 화면"></figure></p><p> </p><p>Admin 계정의 패스워드는 Secret에 암호화되어 있습니다.<br>Secret에서 뽑아낸 ArgoCD의 Admin 패스워드를 <code>ARGO_PASSWORD</code> 환경변수에 보관합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nv>ARGO_PASSWORD</span><span class=o>=</span><span class=k>$(</span>kubectl get secret argocd-initial-admin-secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n argocd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.password}&#34;</span> <span class=p>|</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  base64 -d<span class=k>)</span>
</span></span></code></pre></div><p>Admin 패스워드를 확인해봅니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=nv>$ARGO_PASSWORD</span>
</span></span><span class=line><span class=cl>cymW0qvyzHYuCIRN
</span></span></code></pre></div><p>패스워드도 마찬가지로 각자 환경마다 다르게 출력됩니다.</p><p> </p><p>이제 ArgoCD 웹페이지에서 로그인합니다.</p><p><figure><img class="my-0 rounded-md" src=./3.png alt="로그인 정보 입력"></figure></p><ul><li><strong>ID</strong> : admin</li><li><strong>Password</strong> : <code>echo $ARGO_PASSWORD</code>의 결과값 입력</li></ul><p> </p><h3 id=4-application-배포하기 class="relative group">4. Application 배포하기 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#4-application-%eb%b0%b0%ed%8f%ac%ed%95%98%ea%b8%b0 aria-label=Anchor>#</a></span></h3><h4 id=application class="relative group">Application <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#application aria-label=Anchor>#</a></span></h4><p>ArgoCD는 <code>Application</code>이라는 단위의 커스텀 리소스로 관리합니다.<br><code>Application</code> CRD<sup>Custom Resource Definition</sup>는 환경에 배포된 애플리케이션 인스턴스를 나타내는 Kubernetes 리소스 개체입니다.<br>Application은 쉽게 말해서 ArgoCD가 참조하는(지속적으로 배포하려고 하는) &ldquo;깃허브 소스 레포지터리&rdquo; 대상이라고 이해하면 쉽습니다.</p><p> </p><h4 id=deploy-application class="relative group">Deploy application <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#deploy-application aria-label=Anchor>#</a></span></h4><p>데모 어플리케이션의 매니페스트를 작성합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ cat &lt;&lt; EOF &gt; ./bgd-application.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>argoproj.io/v1alpha1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Application</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bgd-application</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>argocd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>destination</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>bgd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://kubernetes.default.svc </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>project</span><span class=p>:</span><span class=w> </span><span class=l>default </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>source</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>apps/bgd/overlays/bgd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>repoURL</span><span class=p>:</span><span class=w> </span><span class=l>https://github.com/redhat-developer-demos/openshift-gitops-examples</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetRevision</span><span class=p>:</span><span class=w> </span><span class=l>minikube</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>syncPolicy</span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>automated</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>prune</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>selfHeal</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>syncOptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>CreateNamespace=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span><span class=w>
</span></span></span></code></pre></div><p>저희가 배포하려는 데모 어플리케이션의 깃허브 레포지터리 주소는 <a href=https://github.com/redhat-developer-demos/openshift-gitops-examples>https://github.com/redhat-developer-demos/openshift-gitops-examples</a>입니다.<br><code>bgd</code>는 blue-green deployment의 약자입니다.</p><p> </p><p>작성한 매니페스트를 사용해서 데모 어플리케이션을 배포합니다.<br>매니페스트에 이미 <code>namespace: argocd</code> 값이 포함되어 있기 때문에, 배포할 때 네임스페이스 지정 옵션인 <code>-n</code>을 생략해도 됩니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl apply -f bgd-application.yaml
</span></span><span class=line><span class=cl>application.argoproj.io/bgd-application created
</span></span></code></pre></div><p> </p><p>데모 어플리케이션은 기본적으로 <code>bgd</code> 네임스페이스를 사용하도록 설정되어 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get all -n bgd
</span></span></code></pre></div><p> </p><p>데모 어플리케이션의 구조는 크게 보면 Deployment와 Service로 구성되어 있습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>pod/bgd-696c9d9497-mqwpz   1/1     Running   <span class=m>0</span>          2m19s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME          TYPE       CLUSTER-IP    EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>          AGE
</span></span><span class=line><span class=cl>service/bgd   NodePort   10.99.5.226   &lt;none&gt;        8080:32085/TCP   2m19s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>deployment.apps/bgd   1/1     <span class=m>1</span>            <span class=m>1</span>           2m19s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                             DESIRED   CURRENT   READY   AGE
</span></span><span class=line><span class=cl>replicaset.apps/bgd-696c9d9497   <span class=m>1</span>         <span class=m>1</span>         <span class=m>1</span>       2m19s
</span></span></code></pre></div><p> </p><p>ArgoCD 웹에서 데모 어플리케이션의 구성을 확인합니다.</p><p><figure><img class="my-0 rounded-md" src=./4.png alt="bgd argocd"></figure></p><p> </p><p>ArgoCD는 각 Application을 구성하는 모든 리소스를 시각화해서 보여줍니다.<br>이러한 시각화 기능 때문에 많은 기업들이 ArgoCD를 사용하고 있습니다.</p><p><figure><img class="my-0 rounded-md" src=./5.png alt="application 구성"></figure></p><p> </p><p>배포한 어플리케이션 웹페이지에 접속합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube service bgd -n bgd
</span></span></code></pre></div><p>기본 브라우저가 열리면서 자동적으로 서비스를 통해 <code>bgd-application</code>의 웹페이지로 접속됩니다.</p><p><figure><img class="my-0 rounded-md" src=./6.png alt="bgd website on blue"></figure></p><p> </p><h4 id=change-application class="relative group">Change application <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#change-application aria-label=Anchor>#</a></span></h4><p>어플리케이션의 정보를 변경해서 적용합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl patch deploy/bgd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n bgd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --type<span class=o>=</span><span class=s1>&#39;json&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p<span class=o>=</span><span class=s1>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/env/0/value&#34;, &#34;value&#34;:&#34;green&#34;}]&#39;</span>
</span></span><span class=line><span class=cl>deployment.apps/bgd patched
</span></span></code></pre></div><p>웹페이지를 새로고침해서 확인해보면 파란색으로 보이던 웹페이지가 초록색으로 변경되는 걸 확인할 수 있습니다.</p><p><figure><img class="my-0 rounded-md" src=./7.png alt="bgd website on green"></figure></p><p> </p><p>이후 Deployment의 배포 상태를 모니터링합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl rollout status deploy/bgd -n bgd
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Waiting <span class=k>for</span> deployment <span class=s2>&#34;bgd&#34;</span> rollout to finish: <span class=m>1</span> old replicas are pending termination...
</span></span><span class=line><span class=cl>Waiting <span class=k>for</span> deployment <span class=s2>&#34;bgd&#34;</span> rollout to finish: <span class=m>1</span> old replicas are pending termination...
</span></span><span class=line><span class=cl>deployment <span class=s2>&#34;bgd&#34;</span> successfully rolled out
</span></span></code></pre></div><p> </p><p>다시 파란색으로 변경해봅니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl patch deploy/bgd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n bgd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --type<span class=o>=</span><span class=s1>&#39;json&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p<span class=o>=</span><span class=s1>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/env/0/value&#34;, &#34;value&#34;:&#34;blue&#34;}]&#39;</span>
</span></span><span class=line><span class=cl>deployment.apps/bgd patched
</span></span></code></pre></div><p> </p><h3 id=5-selfheal-기능-활성화 class="relative group">5. selfHeal 기능 활성화 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#5-selfheal-%ea%b8%b0%eb%8a%a5-%ed%99%9c%ec%84%b1%ed%99%94 aria-label=Anchor>#</a></span></h3><p><code>bgd-application</code>의 selfHeal 플래그를 <code>true</code>로 설정해서 selfHeal 기능을 활성화합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl patch application/bgd-application <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n argocd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --type<span class=o>=</span>merge <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p<span class=o>=</span><span class=s1>&#39;{&#34;spec&#34;:{&#34;syncPolicy&#34;:{&#34;automated&#34;:{&#34;prune&#34;:true,&#34;selfHeal&#34;:true}}}}&#39;</span>
</span></span><span class=line><span class=cl>application.argoproj.io/bgd-application patched
</span></span></code></pre></div><p> </p><p>ArgoCD 웹페이지에서 Prune과 Self Heal 기능이 활성화되어 있는지 여부를 확인합니다.</p><p><figure><img class="my-0 rounded-md" src=./8.png alt="App details button"></figure></p><p>Application에서 [APP DETAILS] 버튼을 클릭합니다.</p><p> </p><p><figure><img class="my-0 rounded-md" src=./9.png alt="Prune and self heal"></figure></p><p>bgd-application에서 Prune Resources와 Self Heal 기능 둘 다 활성화되어 있는 걸 확인할 수 있습니다.</p><ul><li><strong>Prune Resources</strong> : 깃허브 소스가 업데이트될 때 이전 쿠버네티스 리소스(교체된 Pod, 교체된 ReplicaSet 등)를 자동으로 제거하는 옵션입니다. 안전상의 이유로 ArgoCD의 Prune Resource 값은 기본적으로 비활성화(<code>false</code>) 설정되어 있습니다.<br><a href=https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/#automatic-pruning>ArgoCD 공식문서</a></li><li><strong>Self Heal</strong> : <code>selfHeal</code> 플래그를 <code>true</code>로 설정(활성화)하면 ArgoCD가 지속적으로 git repository의 설정값과 운영 환경 값의 싱크를 맞춥니다. 기본적으로 5초마다 계속해서 sync를 시도하게 됩니다. 시도하는 간격은 <code>argocd-application-controller</code> deployment에 설정된 <code>--self-heal-timeout-seconds</code> 값입니다.<br><a href=https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/#automated-sync-semantics>ArgoCD 공식문서</a></li></ul><p> </p><h2 id=정리하기 class="relative group">정리하기 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%ec%a0%95%eb%a6%ac%ed%95%98%ea%b8%b0 aria-label=Anchor>#</a></span></h2><p>실습환경을 정리하기 위해서 minikube 클러스터를 삭제합니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ minikube delete
</span></span></code></pre></div><p>결과값은 다음과 같습니다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>🔥  docker 의 <span class=s2>&#34;minikube&#34;</span> 를 삭제하는 중 ...
</span></span><span class=line><span class=cl>🔥  Deleting container <span class=s2>&#34;minikube&#34;</span> ...
</span></span><span class=line><span class=cl>🔥  Deleting container <span class=s2>&#34;minikube-m02&#34;</span> ...
</span></span><span class=line><span class=cl>🔥  Deleting container <span class=s2>&#34;minikube-m03&#34;</span> ...
</span></span><span class=line><span class=cl>🔥  /Users/guest/.minikube/machines/minikube 제거 중 ...
</span></span><span class=line><span class=cl>🔥  /Users/guest/.minikube/machines/minikube-m02 제거 중 ...
</span></span><span class=line><span class=cl>🔥  /Users/guest/.minikube/machines/minikube-m03 제거 중 ...
</span></span><span class=line><span class=cl>💀  <span class=s2>&#34;minikube&#34;</span> 클러스터 관련 정보가 모두 삭제되었습니다
</span></span></code></pre></div><p>3대의 minikube 노드가 삭제된 걸 확인할 수 있습니다.</p><p> </p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ kubectl get node
</span></span><span class=line><span class=cl>The connection to the server localhost:8080 was refused - did you specify the right host or port?
</span></span></code></pre></div><p>모든 노드가 사라진 걸 확인할 수 있습니다.</p><p> </p><h2 id=마치며 class="relative group">마치며 <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#%eb%a7%88%ec%b9%98%eb%a9%b0 aria-label=Anchor>#</a></span></h2><p>이것으로 minikube 환경의 ArgoCD 튜토리얼을 마치겠습니다.<br>해당 자료는 Red Hat Developer에 게시된 <a href=https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/01-setup.html>ArgoCD Tutorial</a>을 기반으로 작성했습니다.</p></div></section><footer class="pt-8 max-w-prose print:hidden"><script src=https://utteranc.es/client.js repo=seyslee/seyslee.github.io issue-term=pathname label=blog-comment theme=github-dark crossorigin=anonymous async></script></footer></article></main><footer class="py-10 print:hidden"><div class="flex items-center justify-between"><div><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2022
Younsung Lee</p></div></div></footer></div></body></html>